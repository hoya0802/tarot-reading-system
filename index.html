<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>타로 리딩 시스템</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/tarot.css">
</head>
<body>
    <div id="app">
        <header class="header">
            <div class="container">
                <h1>🔮 타로 리딩 시스템</h1>
                <p>당신의 운명을 읽어드립니다</p>
            </div>
        </header>

        <main class="main">
            <div class="container">
                <!-- 로딩 화면 -->
                <div id="loading" class="section loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>로딩 중...</p>
                </div>

                <!-- 설정 가이드 -->
                <div id="setup" class="section setup" style="display: none;">
                    <h2>🔧 설정이 필요합니다</h2>
                    <p>Supabase 연결을 확인해주세요.</p>
                    <div id="setupStatus">연결 상태 확인 중...</div>
                    <button onclick="testConnection()" class="btn btn-primary">연결 확인</button>
                </div>

                <!-- 목적 선택 -->
                <div id="purpose" class="section purpose-selector">
                    <h2>🎯 리딩 목적을 선택하세요</h2>
                    <div class="purpose-grid">
                        <button class="purpose-card" onclick="selectPurpose('love')">
                            <div class="purpose-icon">💕</div>
                            <h3>사랑과 관계</h3>
                            <p>연인, 가족, 친구와의 관계를 알아보세요</p>
                        </button>
                        <button class="purpose-card" onclick="selectPurpose('career')">
                            <div class="purpose-icon">💼</div>
                            <h3>직장과 업무</h3>
                            <p>커리어와 업무 상황을 점검해보세요</p>
                        </button>
                        <button class="purpose-card" onclick="selectPurpose('daily')">
                            <div class="purpose-icon">🌟</div>
                            <h3>오늘의 운세</h3>
                            <p>오늘 하루의 운세를 확인해보세요</p>
                        </button>
                        <button class="purpose-card" onclick="selectPurpose('health')">
                            <div class="purpose-icon">🏥</div>
                            <h3>건강과 웰빙</h3>
                            <p>건강과 웰빙 상태를 살펴보세요</p>
                        </button>
                        <button class="purpose-card" onclick="selectPurpose('money')">
                            <div class="purpose-icon">💰</div>
                            <h3>재정과 돈</h3>
                            <p>재정 상황과 투자를 점검해보세요</p>
                        </button>
                    </div>
                </div>

                <!-- 카드 선택 -->
                <div id="deck" class="section tarot-deck" style="display: none;">
                    <h2>🎴 카드를 선택하세요</h2>
                    
                    <!-- 랜덤 선택 영역 -->
                    <div class="random-selection-area">
                        <button id="randomSelectBtn" class="random-select-btn" onclick="selectRandomCard()">
                            🎲 카드 랜덤 선택
                        </button>
                        <button class="reset-btn" onclick="resetSelection()">
                            🔄 다시 시작
                        </button>
                    </div>

                    <!-- 선택된 카드 표시 -->
                    <div class="selected-cards-display">
                        <h3>선택된 카드 (<span id="selectedCount">0</span>/3)</h3>
                        <div id="selectedCardsList" class="selected-cards-list">
                            <!-- 선택된 카드들이 여기에 표시됩니다 -->
                        </div>
                        <button id="completeBtn" class="selection-complete" onclick="goToSpread()" style="display: none;">
                            🔮 리딩 시작하기
                        </button>
                    </div>
                </div>

                <!-- 카드 스프레드 -->
                <div id="spread" class="section card-spread" style="display: none;">
                    <h2>🎴 선택된 카드 스프레드</h2>
                    <p class="text-center mb-3">선택된 3장의 카드를 확인하고 리딩을 시작하세요</p>
                    
                    <!-- 디버깅 정보 -->
                    <div id="spreadDebug" class="debug-info">
                        <p><strong>스프레드 디버깅 정보:</strong></p>
                        <p>선택된 카드 수: <span id="debugCardCount">0</span></p>
                        <p>선택된 목적: <span id="debugPurpose">없음</span></p>
                    </div>
                    
                    <div class="spread-container">
                        <div class="spread-layout">
                            <div class="card-position">
                                <h4>과거</h4>
                                <div id="pastCard" class="card-summary">
                                    <h5 id="pastCardName">카드 선택 필요</h5>
                                    <p id="pastCardDirection" class="card-direction">-</p>
                                    <p id="pastCardMeaning" class="card-meaning">과거의 상황을 나타냅니다</p>
                                </div>
                            </div>
                            <div class="card-position">
                                <h4>현재</h4>
                                <div id="presentCard" class="card-summary">
                                    <h5 id="presentCardName">카드 선택 필요</h5>
                                    <p id="presentCardDirection" class="card-direction">-</p>
                                    <p id="presentCardMeaning" class="card-meaning">현재의 상황을 나타냅니다</p>
                                </div>
                            </div>
                            <div class="card-position">
                                <h4>미래</h4>
                                <div id="futureCard" class="card-summary">
                                    <h5 id="futureCardName">카드 선택 필요</h5>
                                    <p id="futureCardDirection" class="card-direction">-</p>
                                    <p id="futureCardMeaning" class="card-meaning">미래의 가능성을 나타냅니다</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button class="btn btn-primary" onclick="startReading()">
                            ✨ 리딩 시작하기
                        </button>
                        <button class="btn btn-secondary" onclick="goToSelection()">
                            🔄 카드 다시 선택
                        </button>
                    </div>
                </div>

                <!-- 리딩 결과 -->
                <div id="result" class="section reading-result" style="display: none;">
                    <h2>✨ 타로 리딩 결과</h2>
                    
                    <!-- 디버깅 정보 -->
                    <div id="resultDebug" class="debug-info">
                        <p><strong>결과 디버깅 정보:</strong></p>
                        <p>선택된 카드 수: <span id="resultDebugCardCount">0</span></p>
                        <p>선택된 목적: <span id="resultDebugPurpose">없음</span></p>
                        <p>카드 의미 수: <span id="resultDebugMeanings">0</span></p>
                    </div>

                    <div class="result-content">
                        <div class="result-summary">
                            <h3>🔮 전체적인 해석</h3>
                            <p id="overallMeaning">리딩 결과가 여기에 표시됩니다.</p>
                        </div>

                        <div class="result-advice">
                            <h3>💡 조언</h3>
                            <p id="advice">조언이 여기에 표시됩니다.</p>
                        </div>

                        <div class="result-cards">
                            <h3>📋 선택된 카드들</h3>
                            <div id="resultCardsList" class="cards-grid">
                                <!-- 선택된 카드들의 상세 정보가 여기에 표시됩니다 -->
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button class="btn btn-primary" onclick="startOver()">
                                🔄 새로운 리딩 시작
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // === 전역 변수들 ===
        let currentStep = 'purpose';
        let selectedPurpose = null;
        let selectedCards = [];
        let allCards = [];
        let readingData = null;
        let supabase = null;

        // === Supabase 설정 ===
        const SUPABASE_URL = 'https://qcubdynkiawpcmsflxfu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjdWJkeW5raWF3cGNtc2ZseGZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0MDgxNzUsImV4cCI6MjA2Nzk4NDE3NX0.c2dFWAcMq62druoosEYY2JaT5FOL--7V9qjCTtPUzi0';

        // === Supabase 초기화 ===
        async function initializeSupabase() {
            try {
                console.log('Supabase 초기화 시작...');
                const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js');
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase 클라이언트 초기화 완료');
                return true;
            } catch (error) {
                console.error('Supabase 클라이언트 초기화 실패:', error);
                return false;
            }
        }

        // === 연결 테스트 ===
        async function simpleConnectionTest() {
            try {
                console.log('간단한 연결 테스트 시작...');
                
                if (!supabase) {
                    const initialized = await initializeSupabase();
                    if (!initialized) {
                        return false;
                    }
                }
                
                const { data, error } = await supabase
                    .from('tarot_cards')
                    .select('name')
                    .limit(1);
                
                if (error) {
                    console.error('간단한 테스트 실패:', error);
                    return false;
                }
                
                console.log('간단한 테스트 성공:', data);
                return true;
            } catch (error) {
                console.error('간단한 테스트 예외:', error);
                return false;
            }
        }

        // === 카드 데이터 가져오기 ===
        async function fetchCards() {
            try {
                console.log('카드 데이터 가져오기 시작...');
                
                if (!supabase) {
                    const initialized = await initializeSupabase();
                    if (!initialized) {
                        throw new Error('Supabase 초기화 실패');
                    }
                }

                const { data, error } = await supabase
                    .from('tarot_cards')
                    .select('*')
                    .order('id');
                
                if (error) throw error;
                
                console.log('카드 데이터 로드 완료:', data.length, '장');
                return data;
            } catch (error) {
                console.error('카드 데이터 가져오기 실패:', error);
                throw error;
            }
        }

        // === 초기화 ===
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('=== 애플리케이션 시작 ===');
            await initializeApp();
        });

        async function initializeApp() {
            try {
                showLoading(true);
                
                // Supabase 연결 테스트
                const isConnected = await simpleConnectionTest();
                if (!isConnected) {
                    showSection('setup');
                    return;
                }

                // 카드 데이터 로드
                const cards = await fetchCards();
                if (cards && cards.length > 0) {
                    allCards = cards;
                    console.log('카드 로드 완료:', allCards.length, '장');
                    showSection('purpose');
                } else {
                    throw new Error('카드 데이터를 불러올 수 없습니다.');
                }
            } catch (error) {
                console.error('초기화 실패:', error);
                showSection('setup');
            } finally {
                showLoading(false);
            }
        }

        // === 섹션 표시 함수 ===
        function showSection(sectionName) {
            console.log('섹션 변경:', currentStep, '→', sectionName);
            
            // 모든 섹션 숨기기
            const sections = ['loading', 'setup', 'purpose', 'deck', 'spread', 'result'];
            sections.forEach(section => {
                document.getElementById(section).style.display = 'none';
            });
            
            // 해당 섹션 표시
            document.getElementById(sectionName).style.display = 'block';
            currentStep = sectionName;
            
            console.log('현재 단계:', currentStep);
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // === 연결 테스트 ===
        async function testConnection() {
            try {
                console.log('연결 확인 버튼 클릭됨');
                document.getElementById('setupStatus').textContent = '연결 테스트 중...';
                
                const isConnected = await simpleConnectionTest();
                if (isConnected) {
                    document.getElementById('setupStatus').textContent = '연결 성공!';
                    alert('연결이 성공했습니다!');
                    await initializeApp();
                } else {
                    document.getElementById('setupStatus').textContent = '연결 실패';
                    alert('연결에 실패했습니다. 콘솔을 확인해주세요.');
                }
            } catch (error) {
                console.error('연결 확인 중 오류:', error);
                document.getElementById('setupStatus').textContent = `연결 오류: ${error.message}`;
                alert(`연결에 실패했습니다: ${error.message}`);
            }
        }

        // === 목적 선택 ===
        function selectPurpose(purpose) {
            console.log('=== 목적 선택됨 ===');
            console.log('선택된 목적:', purpose);
            
            selectedPurpose = purpose;
            showSection('deck');
        }

        // === 랜덤 카드 선택 ===
        function selectRandomCard() {
            console.log('=== 랜덤 카드 선택 ===');
            console.log('현재 선택된 카드 수:', selectedCards.length);
            
            if (selectedCards.length >= 3) {
                console.log('이미 3장이 선택됨');
                return;
            }

            // 이미 선택된 카드 제외
            const availableCards = allCards.filter(card => 
                !selectedCards.some(selected => selected.id === card.id)
            );

            if (availableCards.length === 0) {
                console.log('선택 가능한 카드가 없음');
                return;
            }

            // 랜덤 선택
            const randomIndex = Math.floor(Math.random() * availableCards.length);
            const selectedCard = availableCards[randomIndex];
            
            // 정방향/역방향 랜덤 결정
            selectedCard.reversed = Math.random() < 0.5;
            
            selectedCards.push(selectedCard);
            
            console.log('선택된 카드:', selectedCard.name, selectedCard.reversed ? '(역방향)' : '(정방향)');
            
            updateSelectedCardsDisplay();
        }

        // === 선택된 카드 표시 업데이트 ===
        function updateSelectedCardsDisplay() {
            const countElement = document.getElementById('selectedCount');
            const listElement = document.getElementById('selectedCardsList');
            const completeBtn = document.getElementById('completeBtn');
            
            countElement.textContent = selectedCards.length;
            
            // 카드 리스트 업데이트
            listElement.innerHTML = '';
            selectedCards.forEach((card, index) => {
                const cardItem = document.createElement('div');
                cardItem.className = 'selected-card-item';
                cardItem.innerHTML = `
                    <div class="card-info">
                        <div class="card-number">${index + 1}.</div>
                        <div class="card-details">
                            <div class="card-name">${card.name}</div>
                            <div class="card-direction">${card.reversed ? '역방향' : '정방향'}</div>
                            <div class="card-type">${card.major_minor === 'major' ? '메이저 아르카나' : '마이너 아르카나'}</div>
                        </div>
                        <button class="remove-btn" onclick="removeCard(${index})">×</button>
                    </div>
                `;
                listElement.appendChild(cardItem);
            });
            
            // 완료 버튼 표시/숨김
            if (selectedCards.length === 3) {
                completeBtn.style.display = 'block';
                document.getElementById('randomSelectBtn').disabled = true;
            } else {
                completeBtn.style.display = 'none';
                document.getElementById('randomSelectBtn').disabled = false;
            }
        }

        // === 카드 제거 ===
        function removeCard(index) {
            console.log('카드 제거:', index);
            selectedCards.splice(index, 1);
            updateSelectedCardsDisplay();
        }

        // === 선택 초기화 ===
        function resetSelection() {
            console.log('선택 초기화');
            selectedCards = [];
            updateSelectedCardsDisplay();
        }

        // === 스프레드로 이동 ===
        function goToSpread() {
            console.log('=== 스프레드로 이동 ===');
            console.log('선택된 카드들:', selectedCards);
            
            if (selectedCards.length !== 3) {
                alert('3장의 카드를 모두 선택해주세요.');
                return;
            }
            
            updateSpreadDisplay();
            showSection('spread');
        }

        // === 스프레드 화면 업데이트 ===
        function updateSpreadDisplay() {
            console.log('=== 스프레드 화면 업데이트 ===');
            
            // 디버깅 정보 업데이트
            document.getElementById('debugCardCount').textContent = selectedCards.length;
            document.getElementById('debugPurpose').textContent = selectedPurpose || '없음';
            
            // 카드 정보 업데이트
            const positions = ['past', 'present', 'future'];
            const positionNames = ['과거', '현재', '미래'];
            
            selectedCards.forEach((card, index) => {
                const position = positions[index];
                const positionName = positionNames[index];
                
                document.getElementById(`${position}CardName`).textContent = card.name;
                document.getElementById(`${position}CardDirection`).textContent = 
                    card.reversed ? '역방향' : '정방향';
                document.getElementById(`${position}CardMeaning`).textContent = 
                    `${positionName}의 ${card.reversed ? card.reversed_meaning : card.upright_meaning}`;
            });
        }

        // === 리딩 시작 ===
        async function startReading() {
            console.log('=== 리딩 시작 ===');
            console.log('선택된 카드들:', selectedCards);
            console.log('선택된 목적:', selectedPurpose);
            
            try {
                showLoading(true);
                
                // 카드 의미 분석
                const cardMeanings = selectedCards.map((card, index) => ({
                    name: card.name,
                    position: ['과거', '현재', '미래'][index],
                    meaning: card.reversed ? card.reversed_meaning : card.upright_meaning,
                    keywords: card.keywords,
                    isReversed: card.reversed
                }));
                
                console.log('카드 의미 분석:', cardMeanings);
                
                // 전체 해석 생성
                const overallMeaning = generateOverallMeaning(cardMeanings, selectedPurpose);
                const advice = generateAdvice(cardMeanings, selectedPurpose);
                
                // 리딩 데이터 생성
                readingData = {
                    cards: selectedCards,
                    purpose: selectedPurpose,
                    cardMeanings: cardMeanings,
                    combination: {
                        overall_meaning: overallMeaning,
                        advice: advice
                    },
                    timestamp: new Date()
                };
                
                console.log('리딩 데이터 생성 완료:', readingData);
                
                updateResultDisplay();
                showSection('result');
                
            } catch (error) {
                console.error('리딩 생성 실패:', error);
                alert('리딩을 생성하는 중 오류가 발생했습니다.');
            } finally {
                showLoading(false);
            }
        }

        // === 결과 화면 업데이트 ===
        function updateResultDisplay() {
            console.log('=== 결과 화면 업데이트 ===');
            
            // 디버깅 정보 업데이트
            document.getElementById('resultDebugCardCount').textContent = selectedCards.length;
            document.getElementById('resultDebugPurpose').textContent = selectedPurpose || '없음';
            document.getElementById('resultDebugMeanings').textContent = readingData.cardMeanings.length;
            
            // 해석 결과 표시
            document.getElementById('overallMeaning').textContent = readingData.combination.overall_meaning;
            document.getElementById('advice').textContent = readingData.combination.advice;
            
            // 카드 상세 정보 표시
            const cardsList = document.getElementById('resultCardsList');
            cardsList.innerHTML = '';
            
            readingData.cardMeanings.forEach((cardMeaning, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card-detail';
                cardDiv.innerHTML = `
                    <h4>${cardMeaning.position}: ${cardMeaning.name}</h4>
                    <p class="card-direction">${cardMeaning.isReversed ? '역방향' : '정방향'}</p>
                    <p class="card-meaning">${cardMeaning.meaning}</p>
                    <p class="card-keywords">키워드: ${cardMeaning.keywords}</p>
                `;
                cardsList.appendChild(cardDiv);
            });
        }

        // === 해석 생성 함수들 ===
        function generateOverallMeaning(cardMeanings, purpose) {
            const purposeNames = {
                'love': '사랑과 관계',
                'career': '직장과 업무',
                'daily': '오늘의 운세',
                'health': '건강과 웰빙',
                'money': '재정과 돈'
            };
            
            const purposeName = purposeNames[purpose] || '일반적인';
            const cardNames = cardMeanings.map(card => card.name);
            const keywords = cardMeanings.map(card => card.keywords).join(', ');
            
            return `${purposeName} 측면에서 ${cardNames[0]}, ${cardNames[1]}, ${cardNames[2]}의 조합은 ${keywords}의 에너지를 나타냅니다. 과거의 경험이 현재의 선택에 영향을 미치고, 미래의 방향성을 제시하고 있습니다.`;
        }

        function generateAdvice(cardMeanings, purpose) {
            const reversedCards = cardMeanings.filter(card => card.isReversed);
            const uprightCards = cardMeanings.filter(card => !card.isReversed);
            
            if (reversedCards.length > 1) {
                return '역방향 카드가 많아 현재 어려운 시기를 겪고 있을 수 있습니다. 인내심을 가지고 상황을 관찰하세요.';
            } else if (uprightCards.length > 1) {
                return '정방향 카드가 많아 긍정적인 에너지가 흐르고 있습니다. 자신의 직감을 믿고 행동하세요.';
            } else {
                return '균형 잡힌 카드 배치입니다. 현재 상황을 객관적으로 분석하고 신중하게 판단하세요.';
            }
        }

        // === 네비게이션 함수들 ===
        function goToSelection() {
            showSection('deck');
        }

        function startOver() {
            selectedPurpose = null;
            selectedCards = [];
            readingData = null;
            showSection('purpose');
        }
    </script>
</body>
</html>