<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔮 타로 리딩 시스템</title>
    
    <!-- CSS 파일 -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/tarot.css">
    
    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🔮</text></svg>">
    
    <!-- 디버깅용 스타일 -->
    <style>
        .debug-info {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px;
            border: 1px solid #ccc;
            font-family: monospace;
            font-size: 12px;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            margin: 10px;
            border: 1px solid #ef5350;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 10px;
            margin: 10px;
            border: 1px solid #66bb6a;
        }
    </style>
</head>
<body>
    <!-- 기본 테스트 메시지 -->
    <div class="debug-info">
        <h3>🔮 타로 리딩 시스템 - 기본 테스트</h3>
        <p>이 페이지가 보인다면 기본 HTML은 정상 작동합니다.</p>
        <p>현재 시간: <span id="current-time"></span></p>
        <p>Vue.js 로딩 상태: <span id="vue-status">확인 중...</span></p>
        <p>CSS 로딩 상태: <span id="css-status">확인 중...</span></p>
    </div>

    <div id="app">
        <!-- 로딩 화면 -->
        <div v-if="isLoading" class="loading-screen">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <h2>타로 리딩 시스템 로딩 중...</h2>
                <p>{{ loadingMessage }}</p>
            </div>
        </div>

        <!-- 설정 안내 화면 -->
        <div v-if="showSetupGuide" class="setup-guide">
            <div class="setup-content">
                <h1>🔮 타로 리딩 시스템 설정</h1>
                <div class="setup-steps">
                    <h3>설정 단계:</h3>
                    <ol>
                        <li>Supabase 프로젝트를 생성하세요</li>
                        <li>데이터베이스 스키마를 설정하세요</li>
                        <li>Supabase 연결 정보를 입력하세요</li>
                        <li>페이지를 새로고침하세요</li>
                    </ol>
                </div>
                <div class="setup-help">
                    <h3>도움이 필요하신가요?</h3>
                    <p>README.md 파일을 참고하여 설정을 완료해주세요.</p>
                    <button @click="checkConnection" class="btn btn-primary">연결 확인</button>
                </div>
            </div>
        </div>

        <!-- 메인 애플리케이션 -->
        <div v-if="!isLoading && !showSetupGuide" class="main-app">
            <!-- 헤더 -->
            <header class="app-header">
                <h1>🔮 타로 리딩 시스템</h1>
                <p>당신의 운명을 카드로 읽어보세요</p>
            </header>

            <!-- 메인 컨텐츠 -->
            <main class="app-main">
                <!-- 목적 선택 -->
                <purpose-selector 
                    v-if="currentStep === 'purpose'"
                    @purpose-selected="onPurposeSelected">
                </purpose-selector>

                <!-- 타로 덱 -->
                <tarot-deck 
                    v-if="currentStep === 'deck'"
                    :cards="cards"
                    @selection-complete="onCardSelectionComplete">
                </tarot-deck>

                <!-- 카드 스프레드 -->
                <card-spread 
                    v-if="currentStep === 'spread'"
                    :selectedCards="selectedCards"
                    @start-reading="onStartReading"
                    @reshuffle="onReshuffle">
                </card-spread>

                <!-- 리딩 결과 -->
                <reading-result 
                    v-if="currentStep === 'result'"
                    :readingData="readingData"
                    @new-reading="onNewReading">
                </reading-result>

                <!-- 사용자 히스토리 -->
                <user-history 
                    v-if="currentStep === 'history'"
                    @back-to-main="currentStep = 'purpose'">
                </user-history>
            </main>

            <!-- 네비게이션 -->
            <nav class="app-nav">
                <button @click="currentStep = 'purpose'" class="nav-btn">🏠 홈</button>
                <button @click="currentStep = 'history'" class="nav-btn">📚 히스토리</button>
                <button @click="showConnectionStatus" class="nav-btn">🔗 연결 상태</button>
            </nav>
        </div>
    </div>

    <!-- 메인 애플리케이션 스크립트 -->
    <script type="module">
        import supabase, { checkSupabaseConnection, showSetupGuide, simpleConnectionTest } from './js/services/supabase.js';
        import { loadCards, tarotService } from './js/services/tarotService.js';

        const { createApp } = Vue;

        // Vue 컴포넌트들 정의
        const PurposeSelector = {
            props: ['selectedPurpose'],
            data() {
                return {
                    purposes: [
                        { code: 'love', name: '연애/사랑', icon: '💕', color: '#ff6b6b', description: '사랑과 관계에 관한 해석' },
                        { code: 'career', name: '직장/일', icon: '💼', color: '#4ecdc4', description: '직장과 업무에 관한 해석' },
                        { code: 'daily', name: '오늘의 운세', icon: '☀️', color: '#45b7d1', description: '오늘 하루의 전반적인 운세' },
                        { code: 'health', name: '건강', icon: '🌿', color: '#96ceb4', description: '건강과 웰빙에 관한 해석' },
                        { code: 'money', name: '금전', icon: '💰', color: '#feca57', description: '재정과 돈에 관한 해석' }
                    ]
                };
            },
            template: `
                <div class="section purpose-selector">
                    <h2>🔮 리딩 목적을 선택하세요</h2>
                    <p class="text-center mb-3">어떤 분야에 대해 궁금한가요?</p>
                    
                    <div class="purpose-grid">
                        <div 
                            v-for="purpose in purposes" 
                            :key="purpose.code"
                            class="purpose-item"
                            :class="{ 'selected': selectedPurpose === purpose.code }"
                            :style="{ borderColor: purpose.color }"
                            @click="$emit('purpose-selected', purpose.code)">
                            
                            <div class="purpose-icon">{{ purpose.icon }}</div>
                            <div class="purpose-name">{{ purpose.name }}</div>
                            <div class="purpose-description">{{ purpose.description }}</div>
                            
                            <div v-if="selectedPurpose === purpose.code" class="selected-indicator">
                                ✓ 선택됨
                            </div>
                        </div>
                    </div>
                </div>
            `
        };

        // 기본 테스트 함수들
        function updateCurrentTime() {
            document.getElementById('current-time').textContent = new Date().toLocaleString();
        }

        function checkVueStatus() {
            if (typeof Vue !== 'undefined') {
                document.getElementById('vue-status').textContent = '✅ 로드됨';
                document.getElementById('vue-status').className = 'success';
            } else {
                document.getElementById('vue-status').textContent = '❌ 로드 실패';
                document.getElementById('vue-status').className = 'error';
            }
        }

        function checkCSSStatus() {
            const styleSheets = document.styleSheets;
            let cssLoaded = false;
            
            for (let i = 0; i < styleSheets.length; i++) {
                try {
                    if (styleSheets[i].href && styleSheets[i].href.includes('style.css')) {
                        cssLoaded = true;
                        break;
                    }
                } catch (e) {
                    // CORS 오류 무시
                }
            }
            
            if (cssLoaded) {
                document.getElementById('css-status').textContent = '✅ 로드됨';
                document.getElementById('css-status').className = 'success';
            } else {
                document.getElementById('css-status').textContent = '❌ 로드 실패';
                document.getElementById('css-status').className = 'error';
            }
        }

        // 페이지 로드 시 테스트 실행
        window.addEventListener('load', function() {
            updateCurrentTime();
            checkVueStatus();
            checkCSSStatus();
            
            // 1초마다 시간 업데이트
            setInterval(updateCurrentTime, 1000);
        });

        const app = createApp({
            data() {
                return {
                    isLoading: true,
                    showSetupGuide: false,
                    currentStep: 'purpose',
                    selectedPurpose: null,
                    cards: [],
                    selectedCards: [],
                    readingData: null,
                    loadingMessage: '시스템을 초기화하고 있습니다...'
                };
            },
            async mounted() {
                await this.initializeApp();
            },
            methods: {
                async initializeApp() {
                    try {
                        this.loadingMessage = 'Supabase 연결을 확인하고 있습니다...';
                        
                        // Supabase 연결 확인
                        await checkSupabaseConnection();
                        
                        this.loadingMessage = '카드 데이터를 로딩하고 있습니다...';
                        
                        // 카드 데이터 로드
                        this.cards = await loadCards();
                        
                        this.isLoading = false;
                        console.log('애플리케이션 초기화 완료');
                        
                    } catch (error) {
                        console.error('초기화 실패:', error);
                        this.showSetupGuide = true;
                        this.isLoading = false;
                        showSetupGuide();
                    }
                },
                
                onPurposeSelected(purpose) {
                    this.selectedPurpose = purpose;
                    this.currentStep = 'deck';
                },
                
                onCardSelectionComplete(cards) {
                    this.selectedCards = cards;
                    this.currentStep = 'spread';
                },
                
                onStartReading(cards) {
                    // 리딩 로직 구현 예정
                    this.currentStep = 'result';
                },
                
                onReshuffle() {
                    this.selectedCards = [];
                    this.currentStep = 'deck';
                },
                
                onNewReading() {
                    this.selectedPurpose = null;
                    this.selectedCards = [];
                    this.readingData = null;
                    this.currentStep = 'purpose';
                },
                
                async checkConnection() {
                    try {
                        console.log('연결 확인 버튼 클릭됨');
                        
                        // 간단한 테스트 먼저 실행
                        const simpleTest = await simpleConnectionTest();
                        if (simpleTest) {
                            alert('연결이 성공했습니다!');
                            this.showSetupGuide = false;
                            await this.initializeApp();
                        } else {
                            alert('연결에 실패했습니다. 콘솔을 확인해주세요.');
                        }
                    } catch (error) {
                        console.error('연결 확인 중 오류:', error);
                        alert(`연결에 실패했습니다: ${error.message}`);
                    }
                },
                
                showConnectionStatus() {
                    const status = this.isLoading ? '로딩 중' : 
                                 this.showSetupGuide ? '설정 필요' : '연결됨';
                    alert(`현재 상태: ${status}`);
                }
            }
        });

        // 컴포넌트 등록
        app.component('purpose-selector', PurposeSelector);

        // 앱 마운트
        app.mount('#app');
    </script>
</body>
</html>
