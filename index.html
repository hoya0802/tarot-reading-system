<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íƒ€ë¡œ ë¦¬ë”© ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/tarot.css">
</head>
<body>
    <div id="app">
        <header class="header">
            <div class="container">
                <h1>ğŸ”® íƒ€ë¡œ ë¦¬ë”© ì‹œìŠ¤í…œ</h1>
                <p>ë‹¹ì‹ ì˜ ìš´ëª…ì„ ì½ì–´ë“œë¦½ë‹ˆë‹¤</p>
            </div>
        </header>

        <main class="main">
            <div class="container">
                <!-- ë¡œë”© í™”ë©´ -->
                <div id="loading" class="section loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>ë¡œë”© ì¤‘...</p>
                </div>

                <!-- ì„¤ì • ê°€ì´ë“œ -->
                <div id="setup" class="section setup" style="display: none;">
                    <h2>ğŸ”§ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
                    <p>Supabase ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
                    <div id="setupStatus">ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘...</div>
                    <button onclick="testConnection()" class="btn btn-primary">ì—°ê²° í™•ì¸</button>
                </div>

                <!-- ìƒë…„ì›”ì¼ ì…ë ¥ -->
                <div id="birthDateInput" class="section birth-date-input">
                    <h2>ğŸ“… ìƒë…„ì›”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</h2>
                    <p class="text-center mb-4">ë”ìš± ê°œì¸í™”ëœ íƒ€ë¡œ ë¦¬ë”©ì„ ìœ„í•´ ìƒë…„ì›”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                    
                    <div class="birth-date-form">
                        <div class="form-group">
                            <label for="birthYear">ì¶œìƒë…„ë„</label>
                            <select id="birthYear" class="form-control" required>
                                <option value="">ë…„ë„ ì„ íƒ</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="birthMonth">ì¶œìƒì›”</label>
                            <select id="birthMonth" class="form-control" required>
                                <option value="">ì›” ì„ íƒ</option>
                                <option value="1">1ì›”</option>
                                <option value="2">2ì›”</option>
                                <option value="3">3ì›”</option>
                                <option value="4">4ì›”</option>
                                <option value="5">5ì›”</option>
                                <option value="6">6ì›”</option>
                                <option value="7">7ì›”</option>
                                <option value="8">8ì›”</option>
                                <option value="9">9ì›”</option>
                                <option value="10">10ì›”</option>
                                <option value="11">11ì›”</option>
                                <option value="12">12ì›”</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="birthDay">ì¶œìƒì¼</label>
                            <select id="birthDay" class="form-control" required>
                                <option value="">ì¼ ì„ íƒ</option>
                            </select>
                        </div>
                        
                        <div class="form-actions">
                            <button id="confirmBirthDate" class="btn btn-primary" onclick="confirmBirthDate()">
                                âœ… ìƒë…„ì›”ì¼ í™•ì¸
                            </button>
                            <button class="btn btn-secondary" onclick="skipBirthDate()">
                                â­ï¸ ê±´ë„ˆë›°ê¸°
                            </button>
                        </div>
                        
                        <div class="birth-date-info">
                            <p class="info-text">
                                ğŸ’¡ ìƒë…„ì›”ì¼ì„ ì…ë ¥í•˜ì‹œë©´ ìˆ˜ì¹˜í•™ì  ê´€ì ì„ ë°”íƒ•ìœ¼ë¡œ ë”ìš± ê°œì¸í™”ëœ íƒ€ë¡œ í•´ì„ì„ ì œê³µí•´ë“œë¦½ë‹ˆë‹¤.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- ëª©ì  ì„ íƒ -->
                <div id="purpose" class="section purpose-selector" style="display: none;">
                    <h2>ğŸ¯ ë¦¬ë”© ëª©ì ì„ ì„ íƒí•˜ì„¸ìš”</h2>
                    <div class="birth-date-summary" id="birthDateSummary" style="display: none;">
                        <p class="text-center mb-3">
                            ğŸ“… <span id="displayBirthDate"></span> | 
                            ğŸ”¢ ìƒëª…ìˆ˜: <span id="lifePathNumber"></span> | 
                            ğŸŒ¸ <span id="birthSeason"></span>
                        </p>
                    </div>
                    <div class="purpose-grid">
                        <button class="purpose-card" onclick="selectPurpose('love')">
                            <div class="purpose-icon">ğŸ’•</div>
                            <h3>ì‚¬ë‘ê³¼ ê´€ê³„</h3>
                            <p>ì—°ì¸, ê°€ì¡±, ì¹œêµ¬ì™€ì˜ ê´€ê³„ë¥¼ ì•Œì•„ë³´ì„¸ìš”</p>
                        </button>
                        <button class="purpose-card" onclick="selectPurpose('career')">
                            <div class="purpose-icon">ğŸ’¼</div>
                            <h3>ì§ì¥ê³¼ ì—…ë¬´</h3>
                            <p>ì»¤ë¦¬ì–´ì™€ ì—…ë¬´ ìƒí™©ì„ ì ê²€í•´ë³´ì„¸ìš”</p>
                        </button>
                        <button class="purpose-card" onclick="selectPurpose('daily')">
                            <div class="purpose-icon">ğŸŒŸ</div>
                            <h3>ì˜¤ëŠ˜ì˜ ìš´ì„¸</h3>
                            <p>ì˜¤ëŠ˜ í•˜ë£¨ì˜ ìš´ì„¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”</p>
                        </button>
                        <button class="purpose-card" onclick="selectPurpose('health')">
                            <div class="purpose-icon">ğŸ¥</div>
                            <h3>ê±´ê°•ê³¼ ì›°ë¹™</h3>
                            <p>ê±´ê°•ê³¼ ì›°ë¹™ ìƒíƒœë¥¼ ì‚´í´ë³´ì„¸ìš”</p>
                        </button>
                        <button class="purpose-card" onclick="selectPurpose('money')">
                            <div class="purpose-icon">ğŸ’°</div>
                            <h3>ì¬ì •ê³¼ ëˆ</h3>
                            <p>ì¬ì • ìƒí™©ê³¼ íˆ¬ìë¥¼ ì ê²€í•´ë³´ì„¸ìš”</p>
                        </button>
                    </div>
                </div>

                <!-- ë¦¬ë”© íƒ€ì… ì„ íƒ -->
                <div id="readingType" class="section reading-type-selector" style="display: none;">
                    <h2>ğŸ´ ë¦¬ë”© ë°©ì‹ì„ ì„ íƒí•˜ì„¸ìš”</h2>
                    <p class="text-center mb-4">ì„ íƒí•˜ì‹  ëª©ì : <span id="selectedPurposeName" class="purpose-badge"></span></p>
                    
                    <div class="reading-type-grid">
                        <button class="reading-type-card" onclick="selectReadingType('single')">
                            <div class="type-icon">ğŸ´</div>
                            <h3>í•œ ì¥ ë¦¬ë”©</h3>
                            <p>ì˜¤ëŠ˜ì˜ í•µì‹¬ ë©”ì‹œì§€ì™€ ì¡°ì–¸</p>
                            <div class="type-features">
                                <span class="feature">âœ¨ ë¹ ë¥¸ ë¦¬ë”©</span>
                                <span class="feature">ğŸ¯ í•µì‹¬ ë©”ì‹œì§€</span>
                                <span class="feature">ğŸ’¡ ì¦‰ì‹œ ì¡°ì–¸</span>
                            </div>
                        </button>
                        
                        <button class="reading-type-card" onclick="selectReadingType('three')">
                            <div class="type-icon">ğŸ”®</div>
                            <h3>3ì¥ ìŠ¤í”„ë ˆë“œ</h3>
                            <p>ê³¼ê±°-í˜„ì¬-ë¯¸ë˜ì˜ íë¦„</p>
                            <div class="type-features">
                                <span class="feature">ğŸ“– ìƒì„¸ ë¶„ì„</span>
                                <span class="feature">â° ì‹œê°„ íë¦„</span>
                                <span class="feature">ğŸŒŸ ì¢…í•© í•´ì„</span>
                            </div>
                        </button>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-secondary" onclick="goBackToPurpose()">
                            â† ëª©ì  ë‹¤ì‹œ ì„ íƒ
                        </button>
                    </div>
                </div>

                <!-- í•œ ì¥ ì¹´ë“œ ì„ íƒ -->
                <div id="singleDeck" class="section single-card-deck" style="display: none;">
                    <h2>ğŸ´ í•œ ì¥ì˜ ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
                    <p class="text-center mb-4">
                        ëª©ì : <span id="singlePurposeName" class="purpose-badge"></span> | 
                        ë¦¬ë”© íƒ€ì…: <span class="type-badge">í•œ ì¥ ë¦¬ë”©</span>
                    </p>
                    
                    <!-- ëœë¤ ì„ íƒ ì˜ì—­ -->
                    <div class="single-selection-area">
                        <div class="card-deck-visual">
                            <div class="deck-cards">
                                <div class="deck-card"></div>
                                <div class="deck-card"></div>
                                <div class="deck-card"></div>
                            </div>
                            <p>78ì¥ì˜ ì¹´ë“œ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                        </div>
                        
                        <button id="singleRandomBtn" class="single-random-btn" onclick="selectSingleRandomCard()">
                            âœ¨ ìš´ëª…ì˜ ì¹´ë“œ ë½‘ê¸°
                        </button>
                        
                        <button class="reset-btn" onclick="resetSingleSelection()">
                            ğŸ”„ ë‹¤ì‹œ ë½‘ê¸°
                        </button>
                    </div>

                    <!-- ì„ íƒëœ ì¹´ë“œ í‘œì‹œ -->
                    <div id="singleCardDisplay" class="single-card-display" style="display: none;">
                        <h3>ì„ íƒëœ ì¹´ë“œ</h3>
                        <div id="singleSelectedCard" class="single-selected-card">
                            <!-- ì„ íƒëœ ì¹´ë“œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                        <button id="singleCompleteBtn" class="single-complete" onclick="startSingleReading()">
                            âœ¨ ë¦¬ë”© ì‹œì‘í•˜ê¸°
                        </button>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-secondary" onclick="goBackToReadingType()">
                            â† ë¦¬ë”© ë°©ì‹ ë‹¤ì‹œ ì„ íƒ
                        </button>
                    </div>
                </div>

                <!-- 3ì¥ ì¹´ë“œ ì„ íƒ -->
                <div id="deck" class="section tarot-deck" style="display: none;">
                    <h2>ğŸ´ 3ì¥ì˜ ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
                    <p class="text-center mb-4">
                        ëª©ì : <span id="threePurposeName" class="purpose-badge"></span> | 
                        ë¦¬ë”© íƒ€ì…: <span class="type-badge">3ì¥ ìŠ¤í”„ë ˆë“œ</span>
                    </p>
                    
                    <!-- ëœë¤ ì„ íƒ ì˜ì—­ -->
                    <div class="random-selection-area">
                        <button id="randomSelectBtn" class="random-select-btn" onclick="selectRandomCard()">
                            ğŸ² ì¹´ë“œ ëœë¤ ì„ íƒ
                        </button>
                        <button class="reset-btn" onclick="resetSelection()">
                            ğŸ”„ ë‹¤ì‹œ ì‹œì‘
                        </button>
                    </div>

                    <!-- ì„ íƒëœ ì¹´ë“œ í‘œì‹œ -->
                    <div class="selected-cards-display">
                        <h3>ì„ íƒëœ ì¹´ë“œ (<span id="selectedCount">0</span>/3)</h3>
                        <div id="selectedCardsList" class="selected-cards-list">
                            <!-- ì„ íƒëœ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                        <button id="completeBtn" class="selection-complete" onclick="goToSpread()" style="display: none;">
                            ğŸ”® ë¦¬ë”© ì‹œì‘í•˜ê¸°
                        </button>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-secondary" onclick="goBackToReadingType()">
                            â† ë¦¬ë”© ë°©ì‹ ë‹¤ì‹œ ì„ íƒ
                        </button>
                    </div>
                </div>

                <!-- ì¹´ë“œ ìŠ¤í”„ë ˆë“œ -->
                <div id="spread" class="section card-spread" style="display: none;">
                    <h2>ğŸ´ ì„ íƒëœ ì¹´ë“œ ìŠ¤í”„ë ˆë“œ</h2>
                    <p class="text-center mb-3">ì„ íƒëœ 3ì¥ì˜ ì¹´ë“œë¥¼ í™•ì¸í•˜ê³  ë¦¬ë”©ì„ ì‹œì‘í•˜ì„¸ìš”</p>
                    
                    <!-- ë””ë²„ê¹… ì •ë³´ -->
                    <div id="spreadDebug" class="debug-info">
                        <p><strong>ìŠ¤í”„ë ˆë“œ ë””ë²„ê¹… ì •ë³´:</strong></p>
                        <p>ì„ íƒëœ ì¹´ë“œ ìˆ˜: <span id="debugCardCount">0</span></p>
                        <p>ì„ íƒëœ ëª©ì : <span id="debugPurpose">ì—†ìŒ</span></p>
                    </div>
                    
                    <div class="spread-container">
                        <div class="spread-layout">
                            <div class="card-position">
                                <h4>ê³¼ê±°</h4>
                                <div id="pastCard" class="card-summary">
                                    <h5 id="pastCardName">ì¹´ë“œ ì„ íƒ í•„ìš”</h5>
                                    <p id="pastCardDirection" class="card-direction">-</p>
                                    <p id="pastCardMeaning" class="card-meaning">ê³¼ê±°ì˜ ìƒí™©ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤</p>
                                </div>
                            </div>
                            <div class="card-position">
                                <h4>í˜„ì¬</h4>
                                <div id="presentCard" class="card-summary">
                                    <h5 id="presentCardName">ì¹´ë“œ ì„ íƒ í•„ìš”</h5>
                                    <p id="presentCardDirection" class="card-direction">-</p>
                                    <p id="presentCardMeaning" class="card-meaning">í˜„ì¬ì˜ ìƒí™©ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤</p>
                                </div>
                            </div>
                            <div class="card-position">
                                <h4>ë¯¸ë˜</h4>
                                <div id="futureCard" class="card-summary">
                                    <h5 id="futureCardName">ì¹´ë“œ ì„ íƒ í•„ìš”</h5>
                                    <p id="futureCardDirection" class="card-direction">-</p>
                                    <p id="futureCardMeaning" class="card-meaning">ë¯¸ë˜ì˜ ê°€ëŠ¥ì„±ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button class="btn btn-primary" onclick="startReading()">
                            âœ¨ ë¦¬ë”© ì‹œì‘í•˜ê¸°
                        </button>
                        <button class="btn btn-secondary" onclick="goToSelection()">
                            ğŸ”„ ì¹´ë“œ ë‹¤ì‹œ ì„ íƒ
                        </button>
                    </div>
                </div>

                <!-- í•œ ì¥ ë¦¬ë”© ê²°ê³¼ -->
                <div id="singleResult" class="section single-reading-result" style="display: none;">
                    <h2>âœ¨ í•œ ì¥ ë¦¬ë”© ê²°ê³¼</h2>
                    
                    <div class="single-result-content">
                        <!-- ì„ íƒëœ ì¹´ë“œ í‘œì‹œ -->
                        <div class="single-result-card">
                            <div id="singleResultCardDisplay" class="single-card-large">
                                <!-- ì¹´ë“œ ì´ë¯¸ì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                            </div>
                            <div class="single-card-info">
                                <h3 id="singleResultCardName">ì¹´ë“œ ì´ë¦„</h3>
                                <p id="singleResultCardType" class="card-type">ì¹´ë“œ íƒ€ì…</p>
                                <p id="singleResultCardDirection" class="card-direction">ë°©í–¥</p>
                            </div>
                        </div>

                        <!-- í•µì‹¬ ë©”ì‹œì§€ -->
                        <div class="single-result-message">
                            <h3>ğŸ¯ í•µì‹¬ ë©”ì‹œì§€</h3>
                            <p id="singleCoreMeaning" class="core-meaning">í•µì‹¬ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>

                        <!-- ìƒì„¸ í•´ì„ -->
                        <div class="single-result-sections">
                            <div class="single-section">
                                <h4>ğŸ” ìƒì„¸ í•´ì„</h4>
                                <p id="singleDetailedMeaning">ìƒì„¸ í•´ì„ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                            </div>
                            
                            <div class="single-section">
                                <h4>ğŸ·ï¸ í‚¤ì›Œë“œ</h4>
                                <p id="singleKeywords" class="keywords">í‚¤ì›Œë“œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                            </div>
                            
                            <div class="single-section">
                                <h4 id="singleSpecialTitle">ğŸ’¡ íŠ¹ë³„ ì¡°ì–¸</h4>
                                <p id="singleSpecialInsight">ëª©ì ë³„ íŠ¹ë³„ ì¡°ì–¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                            </div>
                        </div>

                        <!-- ì¡°ì–¸ -->
                        <div class="single-result-advice">
                            <h3>ğŸ’¡ ì˜¤ëŠ˜ì˜ ì¡°ì–¸</h3>
                            <p id="singleAdvice" class="advice-text">ì¡°ì–¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>

                        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                        <div class="single-result-actions">
                            <button class="btn btn-primary" onclick="startOver()">
                                ğŸ”„ ìƒˆë¡œìš´ ë¦¬ë”© ì‹œì‘
                            </button>
                            <button class="btn btn-secondary" onclick="goBackToSingleDeck()">
                                ğŸ´ ë‹¤ë¥¸ ì¹´ë“œ ë½‘ê¸°
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 3ì¥ ë¦¬ë”© ê²°ê³¼ -->
                <div id="result" class="section reading-result" style="display: none;">
                    <h2>âœ¨ 3ì¥ ìŠ¤í”„ë ˆë“œ ë¦¬ë”© ê²°ê³¼</h2>
                    
                    <!-- ë””ë²„ê¹… ì •ë³´ -->
                    <div id="resultDebug" class="debug-info">
                        <p><strong>ê²°ê³¼ ë””ë²„ê¹… ì •ë³´:</strong></p>
                        <p>ì„ íƒëœ ì¹´ë“œ ìˆ˜: <span id="resultDebugCardCount">0</span></p>
                        <p>ì„ íƒëœ ëª©ì : <span id="resultDebugPurpose">ì—†ìŒ</span></p>
                        <p>ì¹´ë“œ ì˜ë¯¸ ìˆ˜: <span id="resultDebugMeanings">0</span></p>
                    </div>

                    <div class="result-content">
                        <div class="result-summary">
                            <h3>ğŸ”® ì „ì²´ì ì¸ í•´ì„</h3>
                            <p id="overallMeaning">ë¦¬ë”© ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>

                        <div class="result-advice">
                            <h3>ğŸ’¡ ì¡°ì–¸</h3>
                            <p id="advice">ì¡°ì–¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>

                        <div class="result-cards">
                            <h3>ğŸ“‹ ì„ íƒëœ ì¹´ë“œë“¤</h3>
                            <div id="resultCardsList" class="cards-grid">
                                <!-- ì„ íƒëœ ì¹´ë“œë“¤ì˜ ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button class="btn btn-primary" onclick="startOver()">
                                ğŸ”„ ìƒˆë¡œìš´ ë¦¬ë”© ì‹œì‘
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // NumerologyService import
        import { NumerologyService } from './js/services/numerologyService.js';
        
        // === ì „ì—­ ë³€ìˆ˜ë“¤ ===
        let currentStep = 'birthDateInput';
        let selectedPurpose = null;
        let selectedReadingType = null; // 'single' ë˜ëŠ” 'three'
        let selectedCards = [];
        let selectedSingleCard = null;
        let allCards = [];
        let readingData = null;
        let supabase = null;
        let userBirthDate = null; // ì‚¬ìš©ì ìƒë…„ì›”ì¼
        let lifePathNumber = null; // ìƒëª…ìˆ˜
        let birthSeason = null; // ì¶œìƒ ê³„ì ˆ

        // === Supabase ì„¤ì • ===
        const SUPABASE_URL = 'https://qcubdynkiawpcmsflxfu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjdWJkeW5raWF3cGNtc2ZseGZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0MDgxNzUsImV4cCI6MjA2Nzk4NDE3NX0.c2dFWAcMq62druoosEYY2JaT5FOL--7V9qjCTtPUzi0';

        // === Supabase ì´ˆê¸°í™” ===
        async function initializeSupabase() {
            try {
                console.log('Supabase ì´ˆê¸°í™” ì‹œì‘...');
                const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js');
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
                return true;
            } catch (error) {
                console.error('Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                return false;
            }
        }

        // === ì—°ê²° í…ŒìŠ¤íŠ¸ ===
        async function simpleConnectionTest() {
            try {
                console.log('ê°„ë‹¨í•œ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...');
                
                if (!supabase) {
                    const initialized = await initializeSupabase();
                    if (!initialized) {
                        return false;
                    }
                }
                
                const { data, error } = await supabase
                    .from('tarot_cards')
                    .select('name')
                    .limit(1);
                
                if (error) {
                    console.error('ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                    return false;
                }
                
                console.log('ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ì„±ê³µ:', data);
                return true;
            } catch (error) {
                console.error('ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ì˜ˆì™¸:', error);
                return false;
            }
        }

        // === ì¹´ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ===
        async function fetchCards() {
            try {
                console.log('ì¹´ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œì‘...');
                
                if (!supabase) {
                    const initialized = await initializeSupabase();
                    if (!initialized) {
                        throw new Error('Supabase ì´ˆê¸°í™” ì‹¤íŒ¨');
                    }
                }

                const { data, error } = await supabase
                    .from('tarot_cards')
                    .select('*')
                    .order('id');
                
                if (error) throw error;
                
                // ì¹´ë“œì— ê·¸ë£¹ ì •ë³´ ì¶”ê°€
                const cardsWithGroups = data.map(card => {
                    let groupId = null;
                    let groupName = null;
                    
                    if (card.major_minor === 'major') {
                        // ë©”ì´ì € ì•„ë¥´ì¹´ë‚˜ ê·¸ë£¹ ë§¤í•‘
                        const majorGroups = {
                            0: { id: 1, name: 'new_beginnings' },
                            1: { id: 1, name: 'new_beginnings' },
                            2: { id: 1, name: 'new_beginnings' },
                            6: { id: 2, name: 'relationships' },
                            11: { id: 2, name: 'relationships' },
                            14: { id: 2, name: 'relationships' },
                            13: { id: 3, name: 'transformation' },
                            16: { id: 3, name: 'transformation' },
                            20: { id: 3, name: 'transformation' },
                            3: { id: 4, name: 'material_world' },
                            4: { id: 4, name: 'material_world' },
                            5: { id: 4, name: 'material_world' },
                            7: { id: 5, name: 'spiritual_journey' },
                            8: { id: 5, name: 'spiritual_journey' },
                            9: { id: 5, name: 'spiritual_journey' },
                            10: { id: 6, name: 'completion' },
                            12: { id: 6, name: 'completion' },
                            15: { id: 6, name: 'completion' },
                            17: { id: 6, name: 'completion' },
                            18: { id: 6, name: 'completion' },
                            19: { id: 6, name: 'completion' },
                            21: { id: 6, name: 'completion' }
                        };
                        const group = majorGroups[card.id] || { id: 6, name: 'completion' };
                        groupId = group.id;
                        groupName = group.name;
                    } else {
                        // ë§ˆì´ë„ˆ ì•„ë¥´ì¹´ë‚˜ ìˆ˜íŠ¸ ë§¤í•‘
                        const suitGroups = {
                            'wands': { id: 7, name: 'wands' },
                            'cups': { id: 8, name: 'cups' },
                            'swords': { id: 9, name: 'swords' },
                            'pentacles': { id: 10, name: 'pentacles' }
                        };
                        const group = suitGroups[card.suit] || { id: 7, name: 'wands' };
                        groupId = group.id;
                        groupName = group.name;
                    }
                    
                    return {
                        ...card,
                        groupId,
                        groupName,
                        displayName: formatCardName(card)
                    };
                });
                
                console.log('ì¹´ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', cardsWithGroups.length, 'ì¥');
                return cardsWithGroups;
            } catch (error) {
                console.error('ì¹´ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                throw error;
            }
        }

        // === ì¹´ë“œ ì´ë¦„ í¬ë§·íŒ… ===
        function formatCardName(card) {
            if (card.major_minor === 'major') {
                return card.name;
            } else {
                const numberNames = {
                    1: 'Ace', 2: 'Two', 3: 'Three', 4: 'Four', 5: 'Five',
                    6: 'Six', 7: 'Seven', 8: 'Eight', 9: 'Nine', 10: 'Ten',
                    11: 'Page', 12: 'Knight', 13: 'Queen', 14: 'King'
                };
                const suitNames = {
                    'wands': 'Wands',
                    'cups': 'Cups', 
                    'swords': 'Swords',
                    'pentacles': 'Pentacles'
                };
                return `${numberNames[card.number]} of ${suitNames[card.suit]}`;
            }
        }

        // === ìƒë…„ì›”ì¼ ê´€ë ¨ í•¨ìˆ˜ë“¤ ===
        function initializeBirthDateForm() {
            // ë…„ë„ ì˜µì…˜ ìƒì„± (1950ë…„ ~ í˜„ì¬)
            const yearSelect = document.getElementById('birthYear');
            const currentYear = new Date().getFullYear();
            
            for (let year = currentYear; year >= 1950; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + 'ë…„';
                yearSelect.appendChild(option);
            }
            
            // ì›” ì„ íƒ ì‹œ ì¼ ì˜µì…˜ ì—…ë°ì´íŠ¸
            document.getElementById('birthMonth').addEventListener('change', updateDayOptions);
            document.getElementById('birthYear').addEventListener('change', updateDayOptions);
        }
        
        function updateDayOptions() {
            const year = document.getElementById('birthYear').value;
            const month = document.getElementById('birthMonth').value;
            const daySelect = document.getElementById('birthDay');
            
            // ê¸°ì¡´ ì˜µì…˜ ì œê±°
            daySelect.innerHTML = '<option value="">ì¼ ì„ íƒ</option>';
            
            if (year && month) {
                const daysInMonth = new Date(year, month, 0).getDate();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day + 'ì¼';
                    daySelect.appendChild(option);
                }
            }
        }
        
        function confirmBirthDate() {
            const year = document.getElementById('birthYear').value;
            const month = document.getElementById('birthMonth').value;
            const day = document.getElementById('birthDay').value;
            
            if (!year || !month || !day) {
                alert('ìƒë…„ì›”ì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ìƒë…„ì›”ì¼ ì €ì¥
            userBirthDate = new Date(year, month - 1, day);
            
            // ìƒëª…ìˆ˜ ê³„ì‚°
            lifePathNumber = calculateLifePathNumber(userBirthDate);
            
            // ì¶œìƒ ê³„ì ˆ ê³„ì‚°
            birthSeason = getBirthSeason(userBirthDate);
            
            console.log('ìƒë…„ì›”ì¼ í™•ì¸:', {
                birthDate: userBirthDate,
                lifePathNumber: lifePathNumber,
                birthSeason: birthSeason
            });
            
            // ëª©ì  ì„ íƒ í™”ë©´ìœ¼ë¡œ ì´ë™
            showSection('purpose');
            
            // ìƒë…„ì›”ì¼ ìš”ì•½ í‘œì‹œ
            displayBirthDateSummary();
        }
        
        function skipBirthDate() {
            console.log('ìƒë…„ì›”ì¼ ì…ë ¥ ê±´ë„ˆë›°ê¸°');
            showSection('purpose');
        }
        
        function calculateLifePathNumber(birthDate) {
            const year = birthDate.getFullYear();
            const month = birthDate.getMonth() + 1;
            const day = birthDate.getDate();
            
            // ê° ë¶€ë¶„ì„ í•œ ìë¦¬ ìˆ«ìë¡œ ì¤„ì´ê¸°
            const yearSum = reduceToSingleDigit(year);
            const monthSum = reduceToSingleDigit(month);
            const daySum = reduceToSingleDigit(day);
            
            // ìµœì¢… ìƒëª…ìˆ˜ ê³„ì‚°
            const lifePathNumber = reduceToSingleDigit(yearSum + monthSum + daySum);
            
            return lifePathNumber;
        }
        
        function reduceToSingleDigit(number) {
            while (number > 9) {
                number = number.toString().split('').reduce((sum, digit) => sum + parseInt(digit), 0);
            }
            return number;
        }
        
        function getBirthSeason(birthDate) {
            const month = birthDate.getMonth() + 1;
            
            if (month >= 3 && month <= 5) return { name: 'ë´„', emoji: 'ğŸŒ¸' };
            if (month >= 6 && month <= 8) return { name: 'ì—¬ë¦„', emoji: 'â˜€ï¸' };
            if (month >= 9 && month <= 11) return { name: 'ê°€ì„', emoji: 'ğŸ‚' };
            return { name: 'ê²¨ìš¸', emoji: 'â„ï¸' };
        }
        
        function displayBirthDateSummary() {
            if (userBirthDate && lifePathNumber && birthSeason) {
                const birthDateStr = userBirthDate.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                document.getElementById('displayBirthDate').textContent = birthDateStr;
                document.getElementById('lifePathNumber').textContent = lifePathNumber;
                document.getElementById('birthSeason').textContent = `${birthSeason.emoji} ${birthSeason.name}`;
                
                document.getElementById('birthDateSummary').style.display = 'block';
            }
        }

        // === ì´ˆê¸°í™” ===
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('=== ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ===');
            
            // ìƒë…„ì›”ì¼ í¼ ì´ˆê¸°í™”
            initializeBirthDateForm();
            
            await initializeApp();
        });

        async function initializeApp() {
            try {
                showLoading(true);
                
                // Supabase ì—°ê²° í…ŒìŠ¤íŠ¸
                const isConnected = await simpleConnectionTest();
                if (!isConnected) {
                    showSection('setup');
                    return;
                }

                // ì¹´ë“œ ë°ì´í„° ë¡œë“œ
                const cards = await fetchCards();
                if (cards && cards.length > 0) {
                    allCards = cards;
                    console.log('ì¹´ë“œ ë¡œë“œ ì™„ë£Œ:', allCards.length, 'ì¥');
                    showSection('birthDateInput');
                } else {
                    throw new Error('ì¹´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                showSection('setup');
            } finally {
                showLoading(false);
            }
        }

        // === ì„¹ì…˜ í‘œì‹œ í•¨ìˆ˜ ===
        function showSection(sectionName) {
            console.log('ì„¹ì…˜ ë³€ê²½:', currentStep, 'â†’', sectionName);
            
            // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            const sections = ['loading', 'setup', 'birthDateInput', 'purpose', 'readingType', 'singleDeck', 'deck', 'spread', 'singleResult', 'result'];
            sections.forEach(section => {
                const element = document.getElementById(section);
                if (element) {
                    element.style.display = 'none';
                }
            });
            
            // í•´ë‹¹ ì„¹ì…˜ í‘œì‹œ
            const targetElement = document.getElementById(sectionName);
            if (targetElement) {
                targetElement.style.display = 'block';
            }
            currentStep = sectionName;
            
            console.log('í˜„ì¬ ë‹¨ê³„:', currentStep);
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // === ì—°ê²° í…ŒìŠ¤íŠ¸ ===
        async function testConnection() {
            try {
                console.log('ì—°ê²° í™•ì¸ ë²„íŠ¼ í´ë¦­ë¨');
                document.getElementById('setupStatus').textContent = 'ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';
                
                const isConnected = await simpleConnectionTest();
                if (isConnected) {
                    document.getElementById('setupStatus').textContent = 'ì—°ê²° ì„±ê³µ!';
                    alert('ì—°ê²°ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!');
                    await initializeApp();
                } else {
                    document.getElementById('setupStatus').textContent = 'ì—°ê²° ì‹¤íŒ¨';
                    alert('ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            } catch (error) {
                console.error('ì—°ê²° í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
                document.getElementById('setupStatus').textContent = `ì—°ê²° ì˜¤ë¥˜: ${error.message}`;
                alert(`ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }

        // === ëª©ì  ì„ íƒ ===
        function selectPurpose(purpose) {
            console.log('=== ëª©ì  ì„ íƒë¨ ===');
            console.log('ì„ íƒëœ ëª©ì :', purpose);
            
            selectedPurpose = purpose;
            
            // ëª©ì  ì´ë¦„ í‘œì‹œ
            const purposeNames = {
                'love': 'ğŸ’• ì‚¬ë‘ê³¼ ê´€ê³„',
                'career': 'ğŸ’¼ ì§ì¥ê³¼ ì—…ë¬´', 
                'daily': 'ğŸŒŸ ì˜¤ëŠ˜ì˜ ìš´ì„¸',
                'health': 'ğŸ¥ ê±´ê°•ê³¼ ì›°ë¹™',
                'money': 'ğŸ’° ì¬ì •ê³¼ ëˆ'
            };
            
            document.getElementById('selectedPurposeName').textContent = purposeNames[purpose];
            showSection('readingType');
        }

        // === ë¦¬ë”© íƒ€ì… ì„ íƒ ===
        function selectReadingType(type) {
            console.log('=== ë¦¬ë”© íƒ€ì… ì„ íƒë¨ ===');
            console.log('ì„ íƒëœ íƒ€ì…:', type);
            
            selectedReadingType = type;
            
            const purposeNames = {
                'love': 'ğŸ’• ì‚¬ë‘ê³¼ ê´€ê³„',
                'career': 'ğŸ’¼ ì§ì¥ê³¼ ì—…ë¬´',
                'daily': 'ğŸŒŸ ì˜¤ëŠ˜ì˜ ìš´ì„¸', 
                'health': 'ğŸ¥ ê±´ê°•ê³¼ ì›°ë¹™',
                'money': 'ğŸ’° ì¬ì •ê³¼ ëˆ'
            };
            
            if (type === 'single') {
                document.getElementById('singlePurposeName').textContent = purposeNames[selectedPurpose];
                showSection('singleDeck');
            } else if (type === 'three') {
                document.getElementById('threePurposeName').textContent = purposeNames[selectedPurpose];
                showSection('deck');
            }
        }

        // === ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë“¤ ===
        function goBackToPurpose() {
            selectedPurpose = null;
            selectedReadingType = null;
            showSection('purpose');
        }

        function goBackToReadingType() {
            selectedReadingType = null;
            selectedCards = [];
            selectedSingleCard = null;
            showSection('readingType');
        }

        function goBackToSingleDeck() {
            selectedSingleCard = null;
            showSection('singleDeck');
        }

        // === ëœë¤ ì¹´ë“œ ì„ íƒ ===
        function selectRandomCard() {
            console.log('=== ëœë¤ ì¹´ë“œ ì„ íƒ ===');
            console.log('í˜„ì¬ ì„ íƒëœ ì¹´ë“œ ìˆ˜:', selectedCards.length);
            
            if (selectedCards.length >= 3) {
                console.log('ì´ë¯¸ 3ì¥ì´ ì„ íƒë¨');
                return;
            }

            // ì´ë¯¸ ì„ íƒëœ ì¹´ë“œ ì œì™¸
            const availableCards = allCards.filter(card => 
                !selectedCards.some(selected => selected.id === card.id)
            );

            if (availableCards.length === 0) {
                console.log('ì„ íƒ ê°€ëŠ¥í•œ ì¹´ë“œê°€ ì—†ìŒ');
                return;
            }

            // ëœë¤ ì„ íƒ
            const randomIndex = Math.floor(Math.random() * availableCards.length);
            const selectedCard = availableCards[randomIndex];
            
            // ì •ë°©í–¥/ì—­ë°©í–¥ ëœë¤ ê²°ì •
            selectedCard.reversed = Math.random() < 0.5;
            
            selectedCards.push(selectedCard);
            
            console.log('ì„ íƒëœ ì¹´ë“œ:', selectedCard.name, selectedCard.reversed ? '(ì—­ë°©í–¥)' : '(ì •ë°©í–¥)');
            
            updateSelectedCardsDisplay();
        }

        // === ì„ íƒëœ ì¹´ë“œ í‘œì‹œ ì—…ë°ì´íŠ¸ ===
        function updateSelectedCardsDisplay() {
            const countElement = document.getElementById('selectedCount');
            const listElement = document.getElementById('selectedCardsList');
            const completeBtn = document.getElementById('completeBtn');
            
            countElement.textContent = selectedCards.length;
            
            // ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            listElement.innerHTML = '';
            selectedCards.forEach((card, index) => {
                const cardItem = document.createElement('div');
                cardItem.className = 'selected-card-item';
                cardItem.innerHTML = `
                    <div class="card-info">
                        <div class="card-number">${index + 1}.</div>
                        <div class="card-details">
                            <div class="card-name">${card.name}</div>
                            <div class="card-direction">${card.reversed ? 'ì—­ë°©í–¥' : 'ì •ë°©í–¥'}</div>
                            <div class="card-type">${card.major_minor === 'major' ? 'ë©”ì´ì € ì•„ë¥´ì¹´ë‚˜' : 'ë§ˆì´ë„ˆ ì•„ë¥´ì¹´ë‚˜'}</div>
                        </div>
                        <button class="remove-btn" onclick="removeCard(${index})">Ã—</button>
                    </div>
                `;
                listElement.appendChild(cardItem);
            });
            
            // ì™„ë£Œ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
            if (selectedCards.length === 3) {
                completeBtn.style.display = 'block';
                document.getElementById('randomSelectBtn').disabled = true;
            } else {
                completeBtn.style.display = 'none';
                document.getElementById('randomSelectBtn').disabled = false;
            }
        }

        // === ì¹´ë“œ ì œê±° ===
        function removeCard(index) {
            console.log('ì¹´ë“œ ì œê±°:', index);
            selectedCards.splice(index, 1);
            updateSelectedCardsDisplay();
        }

        // === ì„ íƒ ì´ˆê¸°í™” ===
        function resetSelection() {
            console.log('ì„ íƒ ì´ˆê¸°í™”');
            selectedCards = [];
            updateSelectedCardsDisplay();
        }

        // === ìŠ¤í”„ë ˆë“œë¡œ ì´ë™ ===
        function goToSpread() {
            console.log('=== ìŠ¤í”„ë ˆë“œë¡œ ì´ë™ ===');
            console.log('ì„ íƒëœ ì¹´ë“œë“¤:', selectedCards);
            
            if (selectedCards.length !== 3) {
                alert('3ì¥ì˜ ì¹´ë“œë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            updateSpreadDisplay();
            showSection('spread');
        }

        // === ìŠ¤í”„ë ˆë“œ í™”ë©´ ì—…ë°ì´íŠ¸ ===
        function updateSpreadDisplay() {
            console.log('=== ìŠ¤í”„ë ˆë“œ í™”ë©´ ì—…ë°ì´íŠ¸ ===');
            
            // ë””ë²„ê¹… ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('debugCardCount').textContent = selectedCards.length;
            document.getElementById('debugPurpose').textContent = selectedPurpose || 'ì—†ìŒ';
            
            // ì¹´ë“œ ì •ë³´ ì—…ë°ì´íŠ¸
            const positions = ['past', 'present', 'future'];
            const positionNames = ['ê³¼ê±°', 'í˜„ì¬', 'ë¯¸ë˜'];
            
            selectedCards.forEach((card, index) => {
                const position = positions[index];
                const positionName = positionNames[index];
                
                document.getElementById(`${position}CardName`).textContent = card.name;
                document.getElementById(`${position}CardDirection`).textContent = 
                    card.reversed ? 'ì—­ë°©í–¥' : 'ì •ë°©í–¥';
                document.getElementById(`${position}CardMeaning`).textContent = 
                    `${positionName}ì˜ ${card.reversed ? card.reversed_meaning : card.upright_meaning}`;
            });
        }

        // === ë¦¬ë”© ì‹œì‘ ===
        async function startReading() {
            console.log('=== ë¦¬ë”© ì‹œì‘ ===');
            console.log('ì„ íƒëœ ì¹´ë“œë“¤:', selectedCards);
            console.log('ì„ íƒëœ ëª©ì :', selectedPurpose);
            console.log('ì‚¬ìš©ì ìƒë…„ì›”ì¼:', userBirthDate);
            console.log('ìƒëª…ìˆ˜:', lifePathNumber);
            console.log('ì¶œìƒ ê³„ì ˆ:', birthSeason);
            
            try {
                showLoading(true);
                
                // ì¹´ë“œì— ê·¸ë£¹ ì •ë³´ ì¶”ê°€
                const cardsWithGroups = selectedCards.map(card => {
                    let groupId = null;
                    
                    if (card.major_minor === 'major') {
                        // ë©”ì´ì € ì•„ë¥´ì¹´ë‚˜ ê·¸ë£¹ ë§¤í•‘
                        const majorGroups = {
                            0: 1, 1: 1, 2: 1,  // new_beginnings
                            6: 2, 11: 2, 14: 2, // relationships  
                            13: 3, 16: 3, 20: 3, // transformation
                            3: 4, 4: 4, 5: 4,   // material_world
                            7: 5, 8: 5, 9: 5,   // spiritual_journey
                            10: 6, 12: 6, 15: 6, 17: 6, 18: 6, 19: 6, 21: 6 // completion
                        };
                        groupId = majorGroups[card.id] || 6;
                    } else {
                        // ë§ˆì´ë„ˆ ì•„ë¥´ì¹´ë‚˜ ìˆ˜íŠ¸ ë§¤í•‘
                        const suitGroups = {
                            'wands': 7,
                            'cups': 8, 
                            'swords': 9,
                            'pentacles': 10
                        };
                        groupId = suitGroups[card.suit] || 7;
                    }
                    
                    return { ...card, groupId };
                });
                
                console.log('ê·¸ë£¹ ì •ë³´ê°€ ì¶”ê°€ëœ ì¹´ë“œë“¤:', cardsWithGroups);
                
                // ëª©ì ë³„ ê°œë³„ ì¹´ë“œ í•´ì„ ì¡°íšŒ
                const cardReadings = await Promise.all(
                    cardsWithGroups.map(async (card) => {
                        try {
                            const { data, error } = await supabase
                                .from('tarot_purpose_readings')
                                .select('*')
                                .eq('card_id', card.id)
                                .eq('purpose_type', selectedPurpose)
                                .single();
                            
                            if (error) throw error;
                            
                            // ìˆ˜ì¹˜í•™ì  ê°œì¸í™” ì ìš©
                            let personalizedMeaning = card.reversed ? data.reversed_meaning : data.upright_meaning;
                            let personalizedAdvice = data.advice;
                            
                            if (userBirthDate && lifePathNumber) {
                                const numerologicalInsight = applyNumerologicalInsight(
                                    card, 
                                    selectedPurpose, 
                                    lifePathNumber, 
                                    birthSeason,
                                    card.reversed
                                );
                                
                                if (numerologicalInsight) {
                                    personalizedMeaning = numerologicalInsight.meaning;
                                    personalizedAdvice = numerologicalInsight.advice;
                                }
                            }
                            
                            return {
                                name: card.name,
                                position: ['ê³¼ê±°', 'í˜„ì¬', 'ë¯¸ë˜'][cardsWithGroups.indexOf(card)],
                                meaning: personalizedMeaning,
                                keywords: data.keywords,
                                advice: personalizedAdvice,
                                isReversed: card.reversed,
                                numerologicalInsight: userBirthDate ? true : false
                            };
                        } catch (error) {
                            console.error('ê°œë³„ ì¹´ë“œ í•´ì„ ì¡°íšŒ ì‹¤íŒ¨:', error);
                            // í´ë°± í•´ì„
                            return {
                                name: card.name,
                                position: ['ê³¼ê±°', 'í˜„ì¬', 'ë¯¸ë˜'][cardsWithGroups.indexOf(card)],
                                meaning: card.reversed ? card.reversed_meaning : card.upright_meaning,
                                keywords: card.keywords,
                                advice: 'í˜„ì¬ ìƒí™©ì„ ì˜ ê´€ì°°í•˜ê³  ì‹ ì¤‘í•˜ê²Œ íŒë‹¨í•˜ì„¸ìš”.',
                                isReversed: card.reversed,
                                numerologicalInsight: false
                            };
                        }
                    })
                );
                
                console.log('ëª©ì ë³„ ì¹´ë“œ í•´ì„:', cardReadings);
                
                // ì¡°í•© í•´ì„ ë™ì  ìƒì„± (tarot_purpose_readings ê¸°ë°˜)
                let combinationReading = generateCombinationReading(cardReadings, selectedPurpose);
                console.log('ë™ì  ì¡°í•© í•´ì„ ìƒì„± ì™„ë£Œ:', combinationReading);
                
                // ìˆ˜ì¹˜í•™ì  ì¡°í•© í•´ì„ ì ìš©
                if (userBirthDate && lifePathNumber) {
                    const numerologicalCombination = applyNumerologicalCombination(
                        combinationReading,
                        selectedPurpose,
                        lifePathNumber,
                        birthSeason,
                        cardReadings
                    );
                    
                    if (numerologicalCombination) {
                        combinationReading = numerologicalCombination;
                    }
                }
                
                // ëª©ì ë³„ íŠ¹í™” ì •ë³´ ì¶”ì¶œ
                const specialInsight = getSpecialInsight(combinationReading, selectedPurpose);
                
                // ë¦¬ë”© ë°ì´í„° ìƒì„±
                readingData = {
                    cards: cardsWithGroups,
                    purpose: selectedPurpose,
                    cardReadings: cardReadings,
                    combination: combinationReading,
                    specialInsight: specialInsight,
                    timestamp: new Date(),
                    numerologicalData: userBirthDate ? {
                        birthDate: userBirthDate,
                        lifePathNumber: lifePathNumber,
                        birthSeason: birthSeason
                    } : null
                };
                
                console.log('ë¦¬ë”© ë°ì´í„° ìƒì„± ì™„ë£Œ:', readingData);
                
                updateResultDisplay();
                showSection('result');
                
            } catch (error) {
                console.error('ë¦¬ë”© ìƒì„± ì‹¤íŒ¨:', error);
                alert('ë¦¬ë”©ì„ ìƒì„±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                showLoading(false);
            }
        }

        // === ëª©ì ë³„ íŠ¹í™” ì •ë³´ ì¶”ì¶œ ===
        function getSpecialInsight(combinationData, purposeType) {
            // ë™ì ìœ¼ë¡œ ìƒì„±ëœ íŠ¹í™” ì •ë³´ ë°˜í™˜
            switch (purposeType) {
                case 'love':
                    return combinationData.love_insights;
                case 'career':
                    return combinationData.career_guidance;
                case 'daily':
                    return combinationData.daily_focus;
                case 'health':
                    return combinationData.health_notes;
                case 'money':
                    return combinationData.money_outlook;
                default:
                    return null;
            }
        }

        // === ê²°ê³¼ í™”ë©´ ì—…ë°ì´íŠ¸ ===
        function updateResultDisplay() {
            console.log('=== ê²°ê³¼ í™”ë©´ ì—…ë°ì´íŠ¸ ===');
            
            // ë””ë²„ê¹… ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('resultDebugCardCount').textContent = selectedCards.length;
            document.getElementById('resultDebugPurpose').textContent = selectedPurpose || 'ì—†ìŒ';
            document.getElementById('resultDebugMeanings').textContent = readingData.cardReadings.length;
            
            // ìˆ˜ì¹˜í•™ì  ì •ë³´ í‘œì‹œ
            let numerologicalInfo = '';
            if (readingData.numerologicalData) {
                const birthDateStr = readingData.numerologicalData.birthDate.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                numerologicalInfo = `
                    <div class="numerological-info">
                        <h4>ğŸ”¢ ìˆ˜ì¹˜í•™ì  ê°œì¸í™” ì •ë³´</h4>
                        <p><strong>ìƒë…„ì›”ì¼:</strong> ${birthDateStr}</p>
                        <p><strong>ìƒëª…ìˆ˜:</strong> ${readingData.numerologicalData.lifePathNumber}</p>
                        <p><strong>ì¶œìƒ ê³„ì ˆ:</strong> ${readingData.numerologicalData.birthSeason.emoji} ${readingData.numerologicalData.birthSeason.name}</p>
                        <p class="numerological-note">ğŸ’¡ ìœ„ì˜ í•´ì„ì€ ìˆ˜ì¹˜í•™ì  ê´€ì ì„ ë°”íƒ•ìœ¼ë¡œ ê°œì¸í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            }
            
            // í•´ì„ ê²°ê³¼ í‘œì‹œ
            document.getElementById('overallMeaning').innerHTML = `
                <div class="reading-sections">
                    <div class="reading-section">
                        <h4>ğŸ“– ê³¼ê±°</h4>
                        <p>${readingData.combination.past_meaning}</p>
                    </div>
                    <div class="reading-section">
                        <h4>ğŸ¯ í˜„ì¬</h4>
                        <p>${readingData.combination.present_meaning}</p>
                    </div>
                    <div class="reading-section">
                        <h4>ğŸ”® ë¯¸ë˜</h4>
                        <p>${readingData.combination.future_meaning}</p>
                    </div>
                    <div class="reading-section full-width">
                        <h4>ğŸŒŸ ì „ì²´ì ì¸ í•´ì„</h4>
                        <p>${readingData.combination.overall_meaning}</p>
                    </div>
                    ${readingData.specialInsight ? `
                        <div class="reading-section full-width purpose-specific">
                            <h4>${getPurposeSpecificTitle(selectedPurpose)}</h4>
                            <p>${readingData.specialInsight}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('advice').textContent = readingData.combination.advice;
            
            // ì¹´ë“œ ìƒì„¸ ì •ë³´ í‘œì‹œ
            const cardsList = document.getElementById('resultCardsList');
            cardsList.innerHTML = '';
            
            readingData.cardReadings.forEach((cardReading, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card-detail';
                cardDiv.innerHTML = `
                    <h4>${cardReading.position}: ${cardReading.name}</h4>
                    <p class="card-direction">${cardReading.isReversed ? 'ì—­ë°©í–¥' : 'ì •ë°©í–¥'}</p>
                    <p class="card-meaning">${cardReading.meaning}</p>
                    <p class="card-keywords">í‚¤ì›Œë“œ: ${cardReading.keywords}</p>
                    <p class="card-advice">ì¡°ì–¸: ${cardReading.advice}</p>
                `;
                cardsList.appendChild(cardDiv);
            });
        }

        // === ëª©ì ë³„ íŠ¹í™” ì œëª© ===
        function getPurposeSpecificTitle(purposeType) {
            const titles = {
                'love': 'ğŸ’• ì—°ì•  íŠ¹ë³„ ì¡°ì–¸',
                'career': 'ğŸ’¼ ì§ì¥ ê°€ì´ë“œ',
                'daily': 'â˜€ï¸ ì˜¤ëŠ˜ì˜ ì§‘ì¤‘ì ',
                'health': 'ğŸŒ¿ ê±´ê°• ì£¼ì˜ì‚¬í•­',
                'money': 'ğŸ’° ê¸ˆì „ ì „ë§'
            };
            return titles[purposeType] || 'íŠ¹ë³„ ì¡°ì–¸';
        }

                // === ìˆ˜ì¹˜í•™ì  ê°œì¸í™” í•¨ìˆ˜ë“¤ ===
        // NumerologyService ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        const numerologyService = new NumerologyService();
        
        async function applyNumerologicalInsight(card, purpose, lifePathNumber, birthSeason, isReversed) {
            try {
                return await numerologyService.applyNumerologicalInsight(card, purpose, lifePathNumber, birthSeason, isReversed);
            } catch (error) {
                console.error('ìˆ˜ì¹˜í•™ì  í•´ì„ ì ìš© ì‹¤íŒ¨:', error);
                return null;
            }
        }

        async function applyNumerologicalCombination(combinationReading, purpose, lifePathNumber, birthSeason, cardReadings) {
            try {
                return await numerologyService.applyNumerologicalCombination(combinationReading, purpose, lifePathNumber, birthSeason, cardReadings);
            } catch (error) {
                console.error('ìˆ˜ì¹˜í•™ì  ì¡°í•© í•´ì„ ì ìš© ì‹¤íŒ¨:', error);
                return null;
            }
        }

        // generateNumerologicalAdvice í•¨ìˆ˜ëŠ” ì œê±°ë¨ - ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°ì–¸ì„ ê°€ì ¸ì˜´

        // === ì¡°í•© í•´ì„ ë™ì  ìƒì„± í•¨ìˆ˜ ===
        function generateCombinationReading(cardReadings, purpose) {
            const positions = ['ê³¼ê±°', 'í˜„ì¬', 'ë¯¸ë˜'];
            
            // ê¸°ë³¸ ì¡°í•© í•´ì„ ìƒì„±
            const combinationReading = {
                past_meaning: cardReadings[0].meaning,
                present_meaning: cardReadings[1].meaning,
                future_meaning: cardReadings[2].meaning,
                overall_meaning: generateOverallMeaning(cardReadings, purpose),
                advice: generateAdvice(cardReadings, purpose)
            };
            
            // ëª©ì ë³„ íŠ¹í™” ì •ë³´ ë™ì  ìƒì„±
            const specialInsights = generateSpecialInsights(cardReadings, purpose);
            Object.assign(combinationReading, specialInsights);
            
            return combinationReading;
        }
        
        // === ëª©ì ë³„ íŠ¹í™” ì •ë³´ ë™ì  ìƒì„± ===
        function generateSpecialInsights(cardReadings, purpose) {
            const insights = {};
            
            switch (purpose) {
                case 'love':
                    insights.love_insights = generateLoveInsights(cardReadings);
                    break;
                case 'career':
                    insights.career_guidance = generateCareerGuidance(cardReadings);
                    break;
                case 'daily':
                    insights.daily_focus = generateDailyFocus(cardReadings);
                    break;
                case 'health':
                    insights.health_notes = generateHealthNotes(cardReadings);
                    break;
                case 'money':
                    insights.money_outlook = generateMoneyOutlook(cardReadings);
                    break;
            }
            
            return insights;
        }
        
        // === ëª©ì ë³„ íŠ¹í™” í•´ì„ ìƒì„± í•¨ìˆ˜ë“¤ ===
        function generateLoveInsights(cardReadings) {
            const reversedCount = cardReadings.filter(card => card.isReversed).length;
            const keywords = cardReadings.map(card => card.keywords).join(', ');
            
            if (reversedCount >= 2) {
                return `í˜„ì¬ ì—°ì•  ìƒí™©ì—ì„œ ì–´ë ¤ì›€ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ${keywords}ì˜ ì—ë„ˆì§€ë¥¼ í†µí•´ ê´€ê³„ì˜ ë¬¸ì œì ì„ íŒŒì•…í•˜ê³  ê°œì„ í•´ë‚˜ê°€ì„¸ìš”.`;
            } else if (reversedCount === 1) {
                return `ì—°ì• ì—ì„œ ì¼ë¶€ ì–´ë ¤ì›€ì´ ìˆì§€ë§Œ, ì „ë°˜ì ìœ¼ë¡œëŠ” ê¸ì •ì ì¸ íë¦„ì…ë‹ˆë‹¤. ${keywords}ì˜ ì¡°í™”ë¥¼ í†µí•´ ê´€ê³„ë¥¼ ë°œì „ì‹œì¼œ ë‚˜ê°€ì„¸ìš”.`;
            } else {
                return `ì—°ì• ì— ë§¤ìš° ê¸ì •ì ì¸ ì—ë„ˆì§€ê°€ íë¥´ê³  ìˆìŠµë‹ˆë‹¤. ${keywords}ì˜ ì¡°í•©ì´ ì‚¬ë‘ì˜ ì„±ì¥ì„ ì´ëŒì–´ë‚¼ ê²ƒì…ë‹ˆë‹¤.`;
            }
        }
        
        function generateCareerGuidance(cardReadings) {
            const reversedCount = cardReadings.filter(card => card.isReversed).length;
            const keywords = cardReadings.map(card => card.keywords).join(', ');
            
            if (reversedCount >= 2) {
                return `ì§ì¥ì—ì„œ ë„ì „ì ì¸ ìƒí™©ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ${keywords}ì˜ ì—ë„ˆì§€ë¥¼ í†µí•´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê³  ì„±ì¥ì˜ ê¸°íšŒë¡œ í™œìš©í•˜ì„¸ìš”.`;
            } else if (reversedCount === 1) {
                return `ì—…ë¬´ì—ì„œ ì¼ë¶€ ì–´ë ¤ì›€ì´ ìˆì§€ë§Œ, ì „ë°˜ì ìœ¼ë¡œëŠ” ë°œì „ì˜ ê¸°íšŒì…ë‹ˆë‹¤. ${keywords}ì˜ ì¡°í•©ì„ í†µí•´ ì»¤ë¦¬ì–´ë¥¼ ë°œì „ì‹œì¼œ ë‚˜ê°€ì„¸ìš”.`;
            } else {
                return `ì§ì¥ì—ì„œ ë§¤ìš° ê¸ì •ì ì¸ ë°œì „ì´ ì˜ˆìƒë©ë‹ˆë‹¤. ${keywords}ì˜ ì¡°í•©ì´ ì„±ê³µê³¼ ì„±ì¥ì„ ì´ëŒì–´ë‚¼ ê²ƒì…ë‹ˆë‹¤.`;
            }
        }
        
        function generateDailyFocus(cardReadings) {
            const keywords = cardReadings.map(card => card.keywords).join(', ');
            const reversedCount = cardReadings.filter(card => card.isReversed).length;
            
            if (reversedCount >= 2) {
                return `ì˜¤ëŠ˜ì€ ì£¼ì˜ê°€ í•„ìš”í•œ ë‚ ì…ë‹ˆë‹¤. ${keywords}ì˜ ì—ë„ˆì§€ë¥¼ í†µí•´ ì–´ë ¤ì›€ì„ ê·¹ë³µí•˜ê³  ì„±ì¥ì˜ ê¸°íšŒë¡œ ì‚¼ìœ¼ì„¸ìš”.`;
            } else if (reversedCount === 1) {
                return `ì˜¤ëŠ˜ì€ ê· í˜•ì„ ì°¾ëŠ” ê²ƒì´ ì¤‘ìš”í•œ ë‚ ì…ë‹ˆë‹¤. ${keywords}ì˜ ì¡°í™”ë¥¼ í†µí•´ í•˜ë£¨ë¥¼ ì˜ë¯¸ ìˆê²Œ ë³´ë‚´ì„¸ìš”.`;
            } else {
                return `ì˜¤ëŠ˜ì€ ë§¤ìš° ê¸ì •ì ì¸ ì—ë„ˆì§€ê°€ ê°€ë“í•œ ë‚ ì…ë‹ˆë‹¤. ${keywords}ì˜ ì¡°í•©ì„ í†µí•´ ì¢‹ì€ ì¼ë“¤ì´ ì¼ì–´ë‚  ê²ƒì…ë‹ˆë‹¤.`;
            }
        }
        
        function generateHealthNotes(cardReadings) {
            const keywords = cardReadings.map(card => card.keywords).join(', ');
            const reversedCount = cardReadings.filter(card => card.isReversed).length;
            
            if (reversedCount >= 2) {
                return `ê±´ê°•ì— ì£¼ì˜ê°€ í•„ìš”í•œ ì‹œê¸°ì…ë‹ˆë‹¤. ${keywords}ì˜ ì—ë„ˆì§€ë¥¼ í†µí•´ ê±´ê°• ê´€ë¦¬ì˜ ì¤‘ìš”ì„±ì„ ì¸ì‹í•˜ê³  ì ê·¹ì ìœ¼ë¡œ ëŒ€ì‘í•˜ì„¸ìš”.`;
            } else if (reversedCount === 1) {
                return `ê±´ê°•ì— ì¼ë¶€ ì£¼ì˜ê°€ í•„ìš”í•˜ì§€ë§Œ, ì „ë°˜ì ìœ¼ë¡œëŠ” ì–‘í˜¸í•©ë‹ˆë‹¤. ${keywords}ì˜ ì¡°í•©ì„ í†µí•´ ê±´ê°•í•œ ë¼ì´í”„ìŠ¤íƒ€ì¼ì„ ìœ ì§€í•˜ì„¸ìš”.`;
            } else {
                return `ê±´ê°•ì— ë§¤ìš° ê¸ì •ì ì¸ ì—ë„ˆì§€ê°€ íë¥´ê³  ìˆìŠµë‹ˆë‹¤. ${keywords}ì˜ ì¡°í•©ì´ ê±´ê°•ê³¼ ì›°ë¹™ì„ ì¦ì§„ì‹œí‚¬ ê²ƒì…ë‹ˆë‹¤.`;
            }
        }
        
        function generateMoneyOutlook(cardReadings) {
            const keywords = cardReadings.map(card => card.keywords).join(', ');
            const reversedCount = cardReadings.filter(card => card.isReversed).length;
            
            if (reversedCount >= 2) {
                return `ì¬ì • ìƒí™©ì—ì„œ ì£¼ì˜ê°€ í•„ìš”í•œ ì‹œê¸°ì…ë‹ˆë‹¤. ${keywords}ì˜ ì—ë„ˆì§€ë¥¼ í†µí•´ ì¬ì • ê´€ë¦¬ë¥¼ ì‹ ì¤‘í•˜ê²Œ í•˜ê³  ìœ„í—˜ì„ í”¼í•˜ì„¸ìš”.`;
            } else if (reversedCount === 1) {
                return `ì¬ì •ì— ì¼ë¶€ ì–´ë ¤ì›€ì´ ìˆì§€ë§Œ, ì „ë°˜ì ìœ¼ë¡œëŠ” ì•ˆì •ì ì…ë‹ˆë‹¤. ${keywords}ì˜ ì¡°í•©ì„ í†µí•´ í˜„ëª…í•œ ì¬ì • ê²°ì •ì„ ë‚´ë¦¬ì„¸ìš”.`;
            } else {
                return `ì¬ì •ì— ë§¤ìš° ê¸ì •ì ì¸ ì „ë§ì´ ìˆìŠµë‹ˆë‹¤. ${keywords}ì˜ ì¡°í•©ì´ ì¬ì •ì  ì„±ê³µê³¼ ì•ˆì •ì„ ê°€ì ¸ì˜¬ ê²ƒì…ë‹ˆë‹¤.`;
            }
        }

        // === í•´ì„ ìƒì„± í•¨ìˆ˜ë“¤ ===
        function generateOverallMeaning(cardMeanings, purpose) {
            const purposeNames = {
                'love': 'ì‚¬ë‘ê³¼ ê´€ê³„',
                'career': 'ì§ì¥ê³¼ ì—…ë¬´',
                'daily': 'ì˜¤ëŠ˜ì˜ ìš´ì„¸',
                'health': 'ê±´ê°•ê³¼ ì›°ë¹™',
                'money': 'ì¬ì •ê³¼ ëˆ'
            };
            
            const purposeName = purposeNames[purpose] || 'ì¼ë°˜ì ì¸';
            const cardNames = cardMeanings.map(card => card.name);
            const keywords = cardMeanings.map(card => card.keywords).join(', ');
            
            return `${purposeName} ì¸¡ë©´ì—ì„œ ${cardNames[0]}, ${cardNames[1]}, ${cardNames[2]}ì˜ ì¡°í•©ì€ ${keywords}ì˜ ì—ë„ˆì§€ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ê³¼ê±°ì˜ ê²½í—˜ì´ í˜„ì¬ì˜ ì„ íƒì— ì˜í–¥ì„ ë¯¸ì¹˜ê³ , ë¯¸ë˜ì˜ ë°©í–¥ì„±ì„ ì œì‹œí•˜ê³  ìˆìŠµë‹ˆë‹¤.`;
        }

        function generateAdvice(cardMeanings, purpose) {
            const reversedCards = cardMeanings.filter(card => card.isReversed);
            const uprightCards = cardMeanings.filter(card => !card.isReversed);
            
            if (reversedCards.length > 1) {
                return 'ì—­ë°©í–¥ ì¹´ë“œê°€ ë§ì•„ í˜„ì¬ ì–´ë ¤ìš´ ì‹œê¸°ë¥¼ ê²ªê³  ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¸ë‚´ì‹¬ì„ ê°€ì§€ê³  ìƒí™©ì„ ê´€ì°°í•˜ì„¸ìš”.';
            } else if (uprightCards.length > 1) {
                return 'ì •ë°©í–¥ ì¹´ë“œê°€ ë§ì•„ ê¸ì •ì ì¸ ì—ë„ˆì§€ê°€ íë¥´ê³  ìˆìŠµë‹ˆë‹¤. ìì‹ ì˜ ì§ê°ì„ ë¯¿ê³  í–‰ë™í•˜ì„¸ìš”.';
            } else {
                return 'ê· í˜• ì¡íŒ ì¹´ë“œ ë°°ì¹˜ì…ë‹ˆë‹¤. í˜„ì¬ ìƒí™©ì„ ê°ê´€ì ìœ¼ë¡œ ë¶„ì„í•˜ê³  ì‹ ì¤‘í•˜ê²Œ íŒë‹¨í•˜ì„¸ìš”.';
            }
        }

        // === ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë“¤ ===
        function goToSelection() {
            showSection('deck');
        }

        // === í•œ ì¥ ì¹´ë“œ ì„ íƒ ===
        function selectSingleRandomCard() {
            console.log('=== í•œ ì¥ ëœë¤ ì¹´ë“œ ì„ íƒ ===');
            
            if (allCards.length === 0) {
                alert('ì¹´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ëœë¤ ì„ íƒ
            const randomIndex = Math.floor(Math.random() * allCards.length);
            const selectedCard = allCards[randomIndex];
            
            // ì •ë°©í–¥/ì—­ë°©í–¥ ëœë¤ ê²°ì •
            selectedCard.reversed = Math.random() < 0.5;
            
            selectedSingleCard = selectedCard;
            
            console.log('ì„ íƒëœ ì¹´ë“œ:', selectedCard.name, selectedCard.reversed ? '(ì—­ë°©í–¥)' : '(ì •ë°©í–¥)');
            
            updateSingleCardDisplay();
        }

        // === í•œ ì¥ ì¹´ë“œ í‘œì‹œ ì—…ë°ì´íŠ¸ ===
        function updateSingleCardDisplay() {
            const card = selectedSingleCard;
            const displayElement = document.getElementById('singleSelectedCard');
            
            displayElement.innerHTML = `
                <div class="single-card-visual">
                    <div class="card-placeholder ${card.reversed ? 'reversed' : ''}" style="
                        width: 200px;
                        height: 320px;
                        background: linear-gradient(135deg, #2c3e50, #34495e);
                        border: 3px solid #ecf0f1;
                        border-radius: 15px;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        text-align: center;
                        padding: 20px;
                        box-shadow: 0 8px 16px rgba(0,0,0,0.3);
                        margin: 0 auto 20px;
                        transform: ${card.reversed ? 'rotate(180deg)' : 'rotate(0deg)'};
                    ">
                        <div style="color: #ecf0f1; font-size: 16px; font-weight: bold; margin-bottom: 10px;">
                            ${card.name}
                        </div>
                        <div style="color: #ecf0f1; font-size: 12px; opacity: 0.8;">
                            ${card.suit ? `${card.suit}` : ''}
                        </div>
                        <div style="color: #ecf0f1; font-size: 10px; opacity: 0.6; margin-top: 10px;">
                            ${card.reversed ? 'Reversed' : 'Upright'}
                        </div>
                    </div>
                </div>
                <div class="single-card-details">
                    <h4>${card.name}</h4>
                    <p class="card-type">${card.major_minor === 'major' ? 'ë©”ì´ì € ì•„ë¥´ì¹´ë‚˜' : 'ë§ˆì´ë„ˆ ì•„ë¥´ì¹´ë‚˜'}</p>
                    <p class="card-direction ${card.reversed ? 'reversed' : 'upright'}">
                        ${card.reversed ? 'ì—­ë°©í–¥' : 'ì •ë°©í–¥'}
                    </p>
                </div>
            `;
            
            document.getElementById('singleCardDisplay').style.display = 'block';
        }

        // === í•œ ì¥ ì„ íƒ ì´ˆê¸°í™” ===
        function resetSingleSelection() {
            console.log('í•œ ì¥ ì„ íƒ ì´ˆê¸°í™”');
            selectedSingleCard = null;
            document.getElementById('singleCardDisplay').style.display = 'none';
        }

        // === í•œ ì¥ ë¦¬ë”© ì‹œì‘ ===
        async function startSingleReading() {
            console.log('=== í•œ ì¥ ë¦¬ë”© ì‹œì‘ ===');
            console.log('ì„ íƒëœ ì¹´ë“œ:', selectedSingleCard);
            console.log('ì„ íƒëœ ëª©ì :', selectedPurpose);
            console.log('ì‚¬ìš©ì ìƒë…„ì›”ì¼:', userBirthDate);
            console.log('ìƒëª…ìˆ˜:', lifePathNumber);
            console.log('ì¶œìƒ ê³„ì ˆ:', birthSeason);
            
            if (!selectedSingleCard) {
                alert('ì¹´ë“œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                showLoading(true);
                
                // ì¹´ë“œì— ê·¸ë£¹ ì •ë³´ ì¶”ê°€
                const cardWithGroup = addGroupInfoToCard(selectedSingleCard);
                
                // ëª©ì ë³„ ê°œë³„ ì¹´ë“œ í•´ì„ ì¡°íšŒ
                let cardReading = null;
                try {
                    const { data, error } = await supabase
                        .from('tarot_purpose_readings')
                        .select('*')
                        .eq('card_id', cardWithGroup.id)
                        .eq('purpose_type', selectedPurpose)
                        .single();
                    
                    if (error) throw error;
                    cardReading = data;
                    console.log('ëª©ì ë³„ ì¹´ë“œ í•´ì„ ì¡°íšŒ ì„±ê³µ:', cardReading);
                } catch (error) {
                    console.error('ëª©ì ë³„ ì¹´ë“œ í•´ì„ ì¡°íšŒ ì‹¤íŒ¨:', error);
                    // í´ë°± í•´ì„
                    cardReading = {
                        upright_meaning: cardWithGroup.upright_meaning,
                        reversed_meaning: cardWithGroup.reversed_meaning,
                        keywords: cardWithGroup.keywords,
                        advice: 'í˜„ì¬ ìƒí™©ì„ ì˜ ê´€ì°°í•˜ê³  ì‹ ì¤‘í•˜ê²Œ íŒë‹¨í•˜ì„¸ìš”.'
                    };
                }
                
                // ìˆ˜ì¹˜í•™ì  ê°œì¸í™” ì ìš©
                let personalizedMeaning = cardWithGroup.reversed ? cardReading.reversed_meaning : cardReading.upright_meaning;
                let personalizedAdvice = cardReading.advice;
                
                if (userBirthDate && lifePathNumber) {
                    const numerologicalInsight = applyNumerologicalInsight(
                        cardWithGroup, 
                        selectedPurpose, 
                        lifePathNumber, 
                        birthSeason,
                        cardWithGroup.reversed
                    );
                    
                    if (numerologicalInsight) {
                        personalizedMeaning = numerologicalInsight.meaning;
                        personalizedAdvice = numerologicalInsight.advice;
                    }
                }
                
                // í•œ ì¥ ë¦¬ë”© íŠ¹í™” í•´ì„ ìƒì„±
                const singleReadingData = generateSingleReadingInsight(
                    { ...cardReading, upright_meaning: personalizedMeaning, advice: personalizedAdvice }, 
                    selectedPurpose, 
                    cardWithGroup.reversed
                );
                
                // ë¦¬ë”© ë°ì´í„° ìƒì„±
                readingData = {
                    type: 'single',
                    card: cardWithGroup,
                    purpose: selectedPurpose,
                    cardReading: { ...cardReading, upright_meaning: personalizedMeaning, advice: personalizedAdvice },
                    singleInsight: singleReadingData,
                    timestamp: new Date(),
                    numerologicalData: userBirthDate ? {
                        birthDate: userBirthDate,
                        lifePathNumber: lifePathNumber,
                        birthSeason: birthSeason
                    } : null
                };
                
                console.log('í•œ ì¥ ë¦¬ë”© ë°ì´í„° ìƒì„± ì™„ë£Œ:', readingData);
                
                updateSingleResultDisplay();
                showSection('singleResult');
                
            } catch (error) {
                console.error('í•œ ì¥ ë¦¬ë”© ìƒì„± ì‹¤íŒ¨:', error);
                alert('ë¦¬ë”©ì„ ìƒì„±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                showLoading(false);
            }
        }

        // === ì¹´ë“œì— ê·¸ë£¹ ì •ë³´ ì¶”ê°€ ===
        function addGroupInfoToCard(card) {
            let groupId = null;
            let groupName = null;
            
            if (card.major_minor === 'major') {
                const majorGroups = {
                    0: { id: 1, name: 'new_beginnings' },
                    1: { id: 1, name: 'new_beginnings' },
                    2: { id: 1, name: 'new_beginnings' },
                    6: { id: 2, name: 'relationships' },
                    11: { id: 2, name: 'relationships' },
                    14: { id: 2, name: 'relationships' },
                    13: { id: 3, name: 'transformation' },
                    16: { id: 3, name: 'transformation' },
                    20: { id: 3, name: 'transformation' },
                    3: { id: 4, name: 'material_world' },
                    4: { id: 4, name: 'material_world' },
                    5: { id: 4, name: 'material_world' },
                    7: { id: 5, name: 'spiritual_journey' },
                    8: { id: 5, name: 'spiritual_journey' },
                    9: { id: 5, name: 'spiritual_journey' },
                    10: { id: 6, name: 'completion' },
                    12: { id: 6, name: 'completion' },
                    15: { id: 6, name: 'completion' },
                    17: { id: 6, name: 'completion' },
                    18: { id: 6, name: 'completion' },
                    19: { id: 6, name: 'completion' },
                    21: { id: 6, name: 'completion' }
                };
                const group = majorGroups[card.id] || { id: 6, name: 'completion' };
                groupId = group.id;
                groupName = group.name;
            } else {
                const suitGroups = {
                    'wands': { id: 7, name: 'wands' },
                    'cups': { id: 8, name: 'cups' },
                    'swords': { id: 9, name: 'swords' },
                    'pentacles': { id: 10, name: 'pentacles' }
                };
                const group = suitGroups[card.suit] || { id: 7, name: 'wands' };
                groupId = group.id;
                groupName = group.name;
            }
            
            return { ...card, groupId, groupName };
        }

        // === í•œ ì¥ ë¦¬ë”© íŠ¹í™” í•´ì„ ìƒì„± ===
        function generateSingleReadingInsight(cardReading, purposeType, isReversed) {
            const meaning = isReversed ? cardReading.reversed_meaning : cardReading.upright_meaning;
            
            const insights = {
                love: {
                    title: 'ğŸ’• ì—°ì•  íŠ¹ë³„ ì¡°ì–¸',
                    focus: 'ì˜¤ëŠ˜ ì—°ì• ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ê²ƒ',
                    action: 'ì·¨í•´ì•¼ í•  í–‰ë™',
                    avoid: 'í”¼í•´ì•¼ í•  ê²ƒ'
                },
                career: {
                    title: 'ğŸ’¼ ì§ì¥ ê°€ì´ë“œ',
                    focus: 'ì—…ë¬´ì—ì„œ ì§‘ì¤‘í•  ì ',
                    action: 'ì˜¤ëŠ˜ì˜ ì—…ë¬´ ì „ëµ', 
                    avoid: 'ì£¼ì˜í•´ì•¼ í•  ìƒí™©'
                },
                daily: {
                    title: 'â˜€ï¸ ì˜¤ëŠ˜ì˜ ì§‘ì¤‘ì ',
                    focus: 'ì˜¤ëŠ˜ì˜ í•µì‹¬ ì—ë„ˆì§€',
                    action: 'ì˜¤ëŠ˜ í•´ì•¼ í•  ì¼',
                    avoid: 'ì˜¤ëŠ˜ í”¼í•´ì•¼ í•  ê²ƒ'
                },
                health: {
                    title: 'ğŸŒ¿ ê±´ê°• ì£¼ì˜ì‚¬í•­',
                    focus: 'ê±´ê°• ê´€ë¦¬ í¬ì¸íŠ¸',
                    action: 'ê±´ê°•ì„ ìœ„í•œ í–‰ë™',
                    avoid: 'ê±´ê°•ì— í•´ë¡œìš´ ê²ƒ'
                },
                money: {
                    title: 'ğŸ’° ê¸ˆì „ ì „ë§',
                    focus: 'ì¬ì • ê´€ë¦¬ í¬ì¸íŠ¸',
                    action: 'ì¬ì •ì„ ìœ„í•œ í–‰ë™',
                    avoid: 'ì¬ì •ì  ìœ„í—˜ ìš”ì†Œ'
                }
            };
            
            return insights[purposeType] || insights.daily;
        }

        // === í•œ ì¥ ë¦¬ë”© ê²°ê³¼ í™”ë©´ ì—…ë°ì´íŠ¸ ===
        function updateSingleResultDisplay() {
            console.log('=== í•œ ì¥ ë¦¬ë”© ê²°ê³¼ í™”ë©´ ì—…ë°ì´íŠ¸ ===');
            
            const card = readingData.card;
            const cardReading = readingData.cardReading;
            const insight = readingData.singleInsight;
            
            // ì¹´ë“œ ì •ë³´ í‘œì‹œ
            document.getElementById('singleResultCardName').textContent = card.name;
            document.getElementById('singleResultCardType').textContent = 
                card.major_minor === 'major' ? 'ë©”ì´ì € ì•„ë¥´ì¹´ë‚˜' : 'ë§ˆì´ë„ˆ ì•„ë¥´ì¹´ë‚˜';
            document.getElementById('singleResultCardDirection').textContent = 
                card.reversed ? 'ì—­ë°©í–¥' : 'ì •ë°©í–¥';
            
            // ì¹´ë“œ ì´ë¯¸ì§€ í‘œì‹œ
            document.getElementById('singleResultCardDisplay').innerHTML = `
                <div class="card-placeholder ${card.reversed ? 'reversed' : ''}" style="
                    width: 250px;
                    height: 400px;
                    background: linear-gradient(135deg, #2c3e50, #34495e);
                    border: 3px solid #ecf0f1;
                    border-radius: 15px;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    text-align: center;
                    padding: 20px;
                    box-shadow: 0 8px 16px rgba(0,0,0,0.3);
                    margin: 0 auto;
                    transform: ${card.reversed ? 'rotate(180deg)' : 'rotate(0deg)'};
                ">
                    <div style="color: #ecf0f1; font-size: 18px; font-weight: bold; margin-bottom: 15px;">
                        ${card.name}
                    </div>
                    <div style="color: #ecf0f1; font-size: 14px; opacity: 0.8;">
                        ${card.suit ? `${card.suit}` : ''}
                    </div>
                    <div style="color: #ecf0f1; font-size: 12px; opacity: 0.6; margin-top: 15px;">
                        ${card.reversed ? 'Reversed' : 'Upright'}
                    </div>
                </div>
            `;
            
            // í•´ì„ ë‚´ìš© í‘œì‹œ
            const meaning = card.reversed ? cardReading.reversed_meaning : cardReading.upright_meaning;
            document.getElementById('singleCoreMeaning').textContent = meaning;
            document.getElementById('singleDetailedMeaning').textContent = meaning;
            document.getElementById('singleKeywords').textContent = cardReading.keywords;
            document.getElementById('singleAdvice').textContent = cardReading.advice;
            
            // ëª©ì ë³„ íŠ¹í™” ì •ë³´
            document.getElementById('singleSpecialTitle').textContent = insight.title;
            document.getElementById('singleSpecialInsight').innerHTML = `
                <p><strong>${insight.focus}:</strong> ${meaning}</p>
                <p><strong>${insight.action}:</strong> ${cardReading.advice}</p>
                <p><strong>${insight.avoid}:</strong> ${card.reversed ? 'í˜„ì¬ ìƒí™©ì„ ë„ˆë¬´ ë¶€ì •ì ìœ¼ë¡œ ë³´ì§€ ë§ˆì„¸ìš”.' : 'ê³¼ë„í•œ ìì‹ ê°ì€ ê¸ˆë¬¼ì…ë‹ˆë‹¤.'}</p>
            `;
        }

        function startOver() {
            selectedPurpose = null;
            selectedReadingType = null;
            selectedCards = [];
            selectedSingleCard = null;
            readingData = null;
            userBirthDate = null;
            lifePathNumber = null;
            birthSeason = null;
            showSection('birthDateInput');
        }
    </script>
</body>
</html>