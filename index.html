<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”® íƒ€ë¡œ ë¦¬ë”© ì‹œìŠ¤í…œ</title>
    
    <!-- CSS íŒŒì¼ -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/tarot.css">
    
    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”®</text></svg>">
    
    <!-- ë””ë²„ê¹…ìš© ìŠ¤íƒ€ì¼ -->
    <style>
        .debug-info {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px;
            border: 1px solid #ccc;
            font-family: monospace;
            font-size: 12px;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            margin: 10px;
            border: 1px solid #ef5350;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 10px;
            margin: 10px;
            border: 1px solid #66bb6a;
        }
    </style>
</head>
<body>
    <!-- ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ -->
    <div class="debug-info">
        <h3>ğŸ”® íƒ€ë¡œ ë¦¬ë”© ì‹œìŠ¤í…œ - ê¸°ë³¸ í…ŒìŠ¤íŠ¸</h3>
        <p>ì´ í˜ì´ì§€ê°€ ë³´ì¸ë‹¤ë©´ ê¸°ë³¸ HTMLì€ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.</p>
        <p>í˜„ì¬ ì‹œê°„: <span id="current-time"></span></p>
        <p>Vue.js ë¡œë”© ìƒíƒœ: <span id="vue-status">í™•ì¸ ì¤‘...</span></p>
        <p>CSS ë¡œë”© ìƒíƒœ: <span id="css-status">í™•ì¸ ì¤‘...</span></p>
    </div>

    <div id="app">
        <!-- ë¡œë”© í™”ë©´ -->
        <div v-if="isLoading" class="loading-screen">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <h2>íƒ€ë¡œ ë¦¬ë”© ì‹œìŠ¤í…œ ë¡œë”© ì¤‘...</h2>
                <p>{{ loadingMessage }}</p>
            </div>
        </div>

        <!-- ì„¤ì • ì•ˆë‚´ í™”ë©´ -->
        <div v-if="showSetupGuide" class="setup-guide">
            <div class="setup-content">
                <h1>ğŸ”® íƒ€ë¡œ ë¦¬ë”© ì‹œìŠ¤í…œ ì„¤ì •</h1>
                <div class="setup-steps">
                    <h3>ì„¤ì • ë‹¨ê³„:</h3>
                    <ol>
                        <li>Supabase í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”</li>
                        <li>ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ì„¤ì •í•˜ì„¸ìš”</li>
                        <li>Supabase ì—°ê²° ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</li>
                        <li>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”</li>
                    </ol>
                </div>
                <div class="setup-help">
                    <h3>ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?</h3>
                    <p>README.md íŒŒì¼ì„ ì°¸ê³ í•˜ì—¬ ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.</p>
                    <button @click="checkConnection" class="btn btn-primary">ì—°ê²° í™•ì¸</button>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ -->
        <div v-if="!isLoading && !showSetupGuide" class="main-app">
            <!-- í—¤ë” -->
            <header class="app-header">
                <h1>ğŸ”® íƒ€ë¡œ ë¦¬ë”© ì‹œìŠ¤í…œ</h1>
                <p>ë‹¹ì‹ ì˜ ìš´ëª…ì„ ì¹´ë“œë¡œ ì½ì–´ë³´ì„¸ìš”</p>
            </header>

            <!-- ë©”ì¸ ì»¨í…ì¸  -->
            <main class="app-main">
                <!-- ëª©ì  ì„ íƒ -->
                <purpose-selector 
                    v-if="currentStep === 'purpose'"
                    @purpose-selected="onPurposeSelected">
                </purpose-selector>

                <!-- íƒ€ë¡œ ë± -->
                <tarot-deck 
                    v-if="currentStep === 'deck'"
                    :cards="cards"
                    @selection-complete="onCardSelectionComplete">
                </tarot-deck>

                <!-- ì¹´ë“œ ìŠ¤í”„ë ˆë“œ -->
                <card-spread 
                    v-if="currentStep === 'spread'"
                    :selectedCards="selectedCards"
                    @start-reading="onStartReading"
                    @reshuffle="onReshuffle">
                </card-spread>

                <!-- ë¦¬ë”© ê²°ê³¼ -->
                <reading-result 
                    v-if="currentStep === 'result'"
                    :readingData="readingData"
                    @new-reading="onNewReading">
                </reading-result>

                <!-- ì‚¬ìš©ì íˆìŠ¤í† ë¦¬ -->
                <user-history 
                    v-if="currentStep === 'history'"
                    @back-to-main="currentStep = 'purpose'">
                </user-history>
            </main>

            <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
            <nav class="app-nav">
                <button @click="currentStep = 'purpose'" class="nav-btn">ğŸ  í™ˆ</button>
                <button @click="currentStep = 'history'" class="nav-btn">ğŸ“š íˆìŠ¤í† ë¦¬</button>
                <button @click="showConnectionStatus" class="nav-btn">ğŸ”— ì—°ê²° ìƒíƒœ</button>
            </nav>
        </div>
    </div>

    <!-- ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="module">
        import supabase, { checkSupabaseConnection, showSetupGuide, simpleConnectionTest } from './js/services/supabase.js';
        import { loadCards, tarotService } from './js/services/tarotService.js';

        const { createApp } = Vue;

        // Vue ì»´í¬ë„ŒíŠ¸ë“¤ ì •ì˜
        const PurposeSelector = {
            props: ['selectedPurpose'],
            data() {
                return {
                    purposes: [
                        { code: 'love', name: 'ì—°ì• /ì‚¬ë‘', icon: 'ğŸ’•', color: '#ff6b6b', description: 'ì‚¬ë‘ê³¼ ê´€ê³„ì— ê´€í•œ í•´ì„' },
                        { code: 'career', name: 'ì§ì¥/ì¼', icon: 'ğŸ’¼', color: '#4ecdc4', description: 'ì§ì¥ê³¼ ì—…ë¬´ì— ê´€í•œ í•´ì„' },
                        { code: 'daily', name: 'ì˜¤ëŠ˜ì˜ ìš´ì„¸', icon: 'â˜€ï¸', color: '#45b7d1', description: 'ì˜¤ëŠ˜ í•˜ë£¨ì˜ ì „ë°˜ì ì¸ ìš´ì„¸' },
                        { code: 'health', name: 'ê±´ê°•', icon: 'ğŸŒ¿', color: '#96ceb4', description: 'ê±´ê°•ê³¼ ì›°ë¹™ì— ê´€í•œ í•´ì„' },
                        { code: 'money', name: 'ê¸ˆì „', icon: 'ğŸ’°', color: '#feca57', description: 'ì¬ì •ê³¼ ëˆì— ê´€í•œ í•´ì„' }
                    ]
                };
            },
            template: `
                <div class="section purpose-selector">
                    <h2>ğŸ”® ë¦¬ë”© ëª©ì ì„ ì„ íƒí•˜ì„¸ìš”</h2>
                    <p class="text-center mb-3">ì–´ë–¤ ë¶„ì•¼ì— ëŒ€í•´ ê¶ê¸ˆí•œê°€ìš”?</p>
                    
                    <div class="purpose-grid">
                        <div 
                            v-for="purpose in purposes" 
                            :key="purpose.code"
                            class="purpose-item"
                            :class="{ 'selected': selectedPurpose === purpose.code }"
                            :style="{ borderColor: purpose.color }"
                            @click="$emit('purpose-selected', purpose.code)">
                            
                            <div class="purpose-icon">{{ purpose.icon }}</div>
                            <div class="purpose-name">{{ purpose.name }}</div>
                            <div class="purpose-description">{{ purpose.description }}</div>
                            
                            <div v-if="selectedPurpose === purpose.code" class="selected-indicator">
                                âœ“ ì„ íƒë¨
                            </div>
                        </div>
                    </div>
                </div>
            `
        };

        // ê¸°ë³¸ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
        function updateCurrentTime() {
            document.getElementById('current-time').textContent = new Date().toLocaleString();
        }

        function checkVueStatus() {
            if (typeof Vue !== 'undefined') {
                document.getElementById('vue-status').textContent = 'âœ… ë¡œë“œë¨';
                document.getElementById('vue-status').className = 'success';
            } else {
                document.getElementById('vue-status').textContent = 'âŒ ë¡œë“œ ì‹¤íŒ¨';
                document.getElementById('vue-status').className = 'error';
            }
        }

        function checkCSSStatus() {
            const styleSheets = document.styleSheets;
            let cssLoaded = false;
            
            for (let i = 0; i < styleSheets.length; i++) {
                try {
                    if (styleSheets[i].href && styleSheets[i].href.includes('style.css')) {
                        cssLoaded = true;
                        break;
                    }
                } catch (e) {
                    // CORS ì˜¤ë¥˜ ë¬´ì‹œ
                }
            }
            
            if (cssLoaded) {
                document.getElementById('css-status').textContent = 'âœ… ë¡œë“œë¨';
                document.getElementById('css-status').className = 'success';
            } else {
                document.getElementById('css-status').textContent = 'âŒ ë¡œë“œ ì‹¤íŒ¨';
                document.getElementById('css-status').className = 'error';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        window.addEventListener('load', function() {
            updateCurrentTime();
            checkVueStatus();
            checkCSSStatus();
            
            // 1ì´ˆë§ˆë‹¤ ì‹œê°„ ì—…ë°ì´íŠ¸
            setInterval(updateCurrentTime, 1000);
        });

        const app = createApp({
            data() {
                return {
                    isLoading: true,
                    showSetupGuide: false,
                    currentStep: 'purpose',
                    selectedPurpose: null,
                    cards: [],
                    selectedCards: [],
                    readingData: null,
                    loadingMessage: 'ì‹œìŠ¤í…œì„ ì´ˆê¸°í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤...'
                };
            },
            async mounted() {
                await this.initializeApp();
            },
            methods: {
                async initializeApp() {
                    try {
                        this.loadingMessage = 'Supabase ì—°ê²°ì„ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
                        
                        // Supabase ì—°ê²° í™•ì¸
                        await checkSupabaseConnection();
                        
                        this.loadingMessage = 'ì¹´ë“œ ë°ì´í„°ë¥¼ ë¡œë”©í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
                        
                        // ì¹´ë“œ ë°ì´í„° ë¡œë“œ
                        this.cards = await loadCards();
                        
                        this.isLoading = false;
                        console.log('ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì™„ë£Œ');
                        
                    } catch (error) {
                        console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                        this.showSetupGuide = true;
                        this.isLoading = false;
                        showSetupGuide();
                    }
                },
                
                onPurposeSelected(purpose) {
                    this.selectedPurpose = purpose;
                    this.currentStep = 'deck';
                },
                
                onCardSelectionComplete(cards) {
                    this.selectedCards = cards;
                    this.currentStep = 'spread';
                },
                
                onStartReading(cards) {
                    // ë¦¬ë”© ë¡œì§ êµ¬í˜„ ì˜ˆì •
                    this.currentStep = 'result';
                },
                
                onReshuffle() {
                    this.selectedCards = [];
                    this.currentStep = 'deck';
                },
                
                onNewReading() {
                    this.selectedPurpose = null;
                    this.selectedCards = [];
                    this.readingData = null;
                    this.currentStep = 'purpose';
                },
                
                async checkConnection() {
                    try {
                        console.log('ì—°ê²° í™•ì¸ ë²„íŠ¼ í´ë¦­ë¨');
                        
                        // ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ë¨¼ì € ì‹¤í–‰
                        const simpleTest = await simpleConnectionTest();
                        if (simpleTest) {
                            alert('ì—°ê²°ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!');
                            this.showSetupGuide = false;
                            await this.initializeApp();
                        } else {
                            alert('ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        }
                    } catch (error) {
                        console.error('ì—°ê²° í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
                        alert(`ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                    }
                },
                
                showConnectionStatus() {
                    const status = this.isLoading ? 'ë¡œë”© ì¤‘' : 
                                 this.showSetupGuide ? 'ì„¤ì • í•„ìš”' : 'ì—°ê²°ë¨';
                    alert(`í˜„ì¬ ìƒíƒœ: ${status}`);
                }
            }
        });

        // ì»´í¬ë„ŒíŠ¸ ë“±ë¡
        app.component('purpose-selector', PurposeSelector);

        // ì•± ë§ˆìš´íŠ¸
        app.mount('#app');
    </script>
</body>
</html>
